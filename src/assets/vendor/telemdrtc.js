(function(root,factory){if(typeof define==="function"&&define.amd){define("easyrtc_lang",factory)}else if(typeof module==="object"&&module.exports){module.exports=factory()}else{root.easyrtc_lang=factory()}})(this,function(undefined){"use strict";return{unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"}});(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define("webrtc-adapter",[],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.adapter=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){var _adapter_factory=require("./adapter_factory.js");var adapter=(0,_adapter_factory.adapterFactory)({window:window});module.exports=adapter},{"./adapter_factory.js":2}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.adapterFactory=adapterFactory;var _utils=require("./utils");var utils=_interopRequireWildcard(_utils);var _chrome_shim=require("./chrome/chrome_shim");var chromeShim=_interopRequireWildcard(_chrome_shim);var _edge_shim=require("./edge/edge_shim");var edgeShim=_interopRequireWildcard(_edge_shim);var _firefox_shim=require("./firefox/firefox_shim");var firefoxShim=_interopRequireWildcard(_firefox_shim);var _safari_shim=require("./safari/safari_shim");var safariShim=_interopRequireWildcard(_safari_shim);var _common_shim=require("./common_shim");var commonShim=_interopRequireWildcard(_common_shim);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function adapterFactory(){var _ref=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},window=_ref.window;var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{shimChrome:true,shimFirefox:true,shimEdge:true,shimSafari:true};var logging=utils.log;var browserDetails=utils.detectBrowser(window);var adapter={browserDetails:browserDetails,commonShim:commonShim,extractVersion:utils.extractVersion,disableLog:utils.disableLog,disableWarnings:utils.disableWarnings};switch(browserDetails.browser){case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection||!options.shimChrome){logging("Chrome shim is not included in this adapter release.");return adapter}logging("adapter.js shimming chrome.");adapter.browserShim=chromeShim;chromeShim.shimGetUserMedia(window);chromeShim.shimMediaStream(window);chromeShim.shimPeerConnection(window);chromeShim.shimOnTrack(window);chromeShim.shimAddTrackRemoveTrack(window);chromeShim.shimGetSendersWithDtmf(window);chromeShim.shimGetStats(window);chromeShim.shimSenderReceiverGetStats(window);chromeShim.fixNegotiationNeeded(window);commonShim.shimRTCIceCandidate(window);commonShim.shimConnectionState(window);commonShim.shimMaxMessageSize(window);commonShim.shimSendThrowTypeError(window);commonShim.removeAllowExtmapMixed(window);break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection||!options.shimFirefox){logging("Firefox shim is not included in this adapter release.");return adapter}logging("adapter.js shimming firefox.");adapter.browserShim=firefoxShim;firefoxShim.shimGetUserMedia(window);firefoxShim.shimPeerConnection(window);firefoxShim.shimOnTrack(window);firefoxShim.shimRemoveStream(window);firefoxShim.shimSenderGetStats(window);firefoxShim.shimReceiverGetStats(window);firefoxShim.shimRTCDataChannel(window);firefoxShim.shimAddTransceiver(window);firefoxShim.shimCreateOffer(window);firefoxShim.shimCreateAnswer(window);commonShim.shimRTCIceCandidate(window);commonShim.shimConnectionState(window);commonShim.shimMaxMessageSize(window);commonShim.shimSendThrowTypeError(window);break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection||!options.shimEdge){logging("MS edge shim is not included in this adapter release.");return adapter}logging("adapter.js shimming edge.");adapter.browserShim=edgeShim;edgeShim.shimGetUserMedia(window);edgeShim.shimGetDisplayMedia(window);edgeShim.shimPeerConnection(window);edgeShim.shimReplaceTrack(window);commonShim.shimMaxMessageSize(window);commonShim.shimSendThrowTypeError(window);break;case"safari":if(!safariShim||!options.shimSafari){logging("Safari shim is not included in this adapter release.");return adapter}logging("adapter.js shimming safari.");adapter.browserShim=safariShim;safariShim.shimRTCIceServerUrls(window);safariShim.shimCreateOfferLegacy(window);safariShim.shimCallbacksAPI(window);safariShim.shimLocalStreamsAPI(window);safariShim.shimRemoteStreamsAPI(window);safariShim.shimTrackEventTransceiver(window);safariShim.shimGetUserMedia(window);commonShim.shimRTCIceCandidate(window);commonShim.shimMaxMessageSize(window);commonShim.shimSendThrowTypeError(window);commonShim.removeAllowExtmapMixed(window);break;default:logging("Unsupported browser!");break}return adapter}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimMediaStream=shimMediaStream;exports.shimOnTrack=shimOnTrack;exports.shimGetSendersWithDtmf=shimGetSendersWithDtmf;exports.shimGetStats=shimGetStats;exports.shimSenderReceiverGetStats=shimSenderReceiverGetStats;exports.shimAddTrackRemoveTrackWithNative=shimAddTrackRemoveTrackWithNative;exports.shimAddTrackRemoveTrack=shimAddTrackRemoveTrack;exports.shimPeerConnection=shimPeerConnection;exports.fixNegotiationNeeded=fixNegotiationNeeded;var _utils=require("../utils.js");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function shimMediaStream(window){window.MediaStream=window.MediaStream||window.webkitMediaStream}function shimOnTrack(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function get(){return this._ontrack},set:function set(f){if(this._ontrack){this.removeEventListener("track",this._ontrack)}this.addEventListener("track",this._ontrack=f)},enumerable:true,configurable:true});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var _this=this;if(!this._ontrackpoly){this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var receiver=void 0;if(window.RTCPeerConnection.prototype.getReceivers){receiver=_this.getReceivers().find(function(r){return r.track&&r.track.id===te.track.id})}else{receiver={track:te.track}}var event=new Event("track");event.track=te.track;event.receiver=receiver;event.transceiver={receiver:receiver};event.streams=[e.stream];_this.dispatchEvent(event)});e.stream.getTracks().forEach(function(track){var receiver=void 0;if(window.RTCPeerConnection.prototype.getReceivers){receiver=_this.getReceivers().find(function(r){return r.track&&r.track.id===track.id})}else{receiver={track:track}}var event=new Event("track");event.track=track;event.receiver=receiver;event.transceiver={receiver:receiver};event.streams=[e.stream];_this.dispatchEvent(event)})};this.addEventListener("addstream",this._ontrackpoly)}return origSetRemoteDescription.apply(this,arguments)}}else{utils.wrapPeerConnectionEvent(window,"track",function(e){if(!e.transceiver){Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}})}return e})}}function shimGetSendersWithDtmf(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&!("getSenders"in window.RTCPeerConnection.prototype)&&"createDTMFSender"in window.RTCPeerConnection.prototype){var shimSenderWithDtmf=function shimSenderWithDtmf(pc,track){return{track:track,get dtmf(){if(this._dtmf===undefined){if(track.kind==="audio"){this._dtmf=pc.createDTMFSender(track)}else{this._dtmf=null}}return this._dtmf},_pc:pc}};if(!window.RTCPeerConnection.prototype.getSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){this._senders=this._senders||[];return this._senders.slice()};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){var sender=origAddTrack.apply(this,arguments);if(!sender){sender=shimSenderWithDtmf(this,track);this._senders.push(sender)}return sender};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){origRemoveTrack.apply(this,arguments);var idx=this._senders.indexOf(sender);if(idx!==-1){this._senders.splice(idx,1)}}}var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this2=this;this._senders=this._senders||[];origAddStream.apply(this,[stream]);stream.getTracks().forEach(function(track){_this2._senders.push(shimSenderWithDtmf(_this2,track))})};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this3=this;this._senders=this._senders||[];origRemoveStream.apply(this,[stream]);stream.getTracks().forEach(function(track){var sender=_this3._senders.find(function(s){return s.track===track});if(sender){_this3._senders.splice(_this3._senders.indexOf(sender),1)}})}}else if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&"getSenders"in window.RTCPeerConnection.prototype&&"createDTMFSender"in window.RTCPeerConnection.prototype&&window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this4=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this4});return senders};Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function get(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=this._pc.createDTMFSender(this.track)}else{this._dtmf=null}}return this._dtmf}})}}function shimGetStats(window){if(!window.RTCPeerConnection){return}var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){var _this5=this;var _arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];if(arguments.length>0&&typeof selector==="function"){return origGetStats.apply(this,arguments)}if(origGetStats.length===0&&(arguments.length===0||typeof selector!=="function")){return origGetStats.apply(this,[])}var fixChromeStats_=function fixChromeStats_(response){var standardReport={};var reports=response.result();reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)});standardReport[standardStats.id]=standardStats});return standardReport};var makeMapStats=function makeMapStats(stats){return new Map(Object.keys(stats).map(function(key){return[key,stats[key]]}))};if(arguments.length>=2){var successCallbackWrapper_=function successCallbackWrapper_(response){onSucc(makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,selector])}return new Promise(function(resolve,reject){origGetStats.apply(_this5,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(onSucc,onErr)}}function shimSenderReceiverGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender&&window.RTCRtpReceiver)){return}if(!("getStats"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;if(origGetSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this6=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this6});return senders}}var origAddTrack=window.RTCPeerConnection.prototype.addTrack;if(origAddTrack){window.RTCPeerConnection.prototype.addTrack=function addTrack(){var sender=origAddTrack.apply(this,arguments);sender._pc=this;return sender}}window.RTCRtpSender.prototype.getStats=function getStats(){var sender=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,sender.track,true)})}}if(!("getStats"in window.RTCRtpReceiver.prototype)){var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;if(origGetReceivers){window.RTCPeerConnection.prototype.getReceivers=function getReceivers(){var _this7=this;var receivers=origGetReceivers.apply(this,[]);receivers.forEach(function(receiver){return receiver._pc=_this7});return receivers}}utils.wrapPeerConnectionEvent(window,"track",function(e){e.receiver._pc=e.srcElement;return e});window.RTCRtpReceiver.prototype.getStats=function getStats(){var receiver=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,receiver.track,false)})}}if(!("getStats"in window.RTCRtpSender.prototype&&"getStats"in window.RTCRtpReceiver.prototype)){return}var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){if(arguments.length>0&&arguments[0]instanceof window.MediaStreamTrack){var track=arguments[0];var sender=void 0;var receiver=void 0;var err=void 0;this.getSenders().forEach(function(s){if(s.track===track){if(sender){err=true}else{sender=s}}});this.getReceivers().forEach(function(r){if(r.track===track){if(receiver){err=true}else{receiver=r}}return r.track===track});if(err||sender&&receiver){return Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError"))}else if(sender){return sender.getStats()}else if(receiver){return receiver.getStats()}return Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return origGetStats.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(window){window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){var _this8=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map(function(streamId){return _this8._shimmedLocalStreams[streamId][0]})};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){if(!stream){return origAddTrack.apply(this,arguments)}this._shimmedLocalStreams=this._shimmedLocalStreams||{};var sender=origAddTrack.apply(this,arguments);if(!this._shimmedLocalStreams[stream.id]){this._shimmedLocalStreams[stream.id]=[stream,sender]}else if(this._shimmedLocalStreams[stream.id].indexOf(sender)===-1){this._shimmedLocalStreams[stream.id].push(sender)}return sender};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this9=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};stream.getTracks().forEach(function(track){var alreadyExists=_this9.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}});var existingSenders=this.getSenders();origAddStream.apply(this,arguments);var newSenders=this.getSenders().filter(function(newSender){return existingSenders.indexOf(newSender)===-1});this._shimmedLocalStreams[stream.id]=[stream].concat(newSenders)};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[stream.id];return origRemoveStream.apply(this,arguments)};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){var _this10=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};if(sender){Object.keys(this._shimmedLocalStreams).forEach(function(streamId){var idx=_this10._shimmedLocalStreams[streamId].indexOf(sender);if(idx!==-1){_this10._shimmedLocalStreams[streamId].splice(idx,1)}if(_this10._shimmedLocalStreams[streamId].length===1){delete _this10._shimmedLocalStreams[streamId]}})}return origRemoveTrack.apply(this,arguments)}}function shimAddTrackRemoveTrack(window){if(!window.RTCPeerConnection){return}var browserDetails=utils.detectBrowser(window);if(window.RTCPeerConnection.prototype.addTrack&&browserDetails.version>=65){return shimAddTrackRemoveTrackWithNative(window)}var origGetLocalStreams=window.RTCPeerConnection.prototype.getLocalStreams;window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){var _this11=this;var nativeStreams=origGetLocalStreams.apply(this);this._reverseStreams=this._reverseStreams||{};return nativeStreams.map(function(stream){return _this11._reverseStreams[stream.id]})};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this12=this;this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};stream.getTracks().forEach(function(track){var alreadyExists=_this12.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}});if(!this._reverseStreams[stream.id]){var newStream=new window.MediaStream(stream.getTracks());this._streams[stream.id]=newStream;this._reverseStreams[newStream.id]=stream;stream=newStream}origAddStream.apply(this,[stream])};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};origRemoveStream.apply(this,[this._streams[stream.id]||stream]);delete this._reverseStreams[this._streams[stream.id]?this._streams[stream.id].id:stream.id];delete this._streams[stream.id]};window.RTCPeerConnection.prototype.addTrack=function addTrack(track,stream){var _this13=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}var streams=[].slice.call(arguments,1);if(streams.length!==1||!streams[0].getTracks().find(function(t){return t===track})){throw new DOMException("The adapter.js addTrack polyfill only supports a single "+" stream which is associated with the specified track.","NotSupportedError")}var alreadyExists=this.getSenders().find(function(s){return s.track===track});if(alreadyExists){throw new DOMException("Track already exists.","InvalidAccessError")}this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};var oldStream=this._streams[stream.id];if(oldStream){oldStream.addTrack(track);Promise.resolve().then(function(){_this13.dispatchEvent(new Event("negotiationneeded"))})}else{var newStream=new window.MediaStream([track]);this._streams[stream.id]=newStream;this._reverseStreams[newStream.id]=stream;this.addStream(newStream)}return this.getSenders().find(function(s){return s.track===track})};function replaceInternalStreamId(pc,description){var sdp=description.sdp;Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId];var internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(internalStream.id,"g"),externalStream.id)});return new RTCSessionDescription({type:description.type,sdp:sdp})}function replaceExternalStreamId(pc,description){var sdp=description.sdp;Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId];var internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(externalStream.id,"g"),internalStream.id)});return new RTCSessionDescription({type:description.type,sdp:sdp})}["createOffer","createAnswer"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){var _this14=this;var args=arguments;var isLegacyCall=arguments.length&&typeof arguments[0]==="function";if(isLegacyCall){return nativeMethod.apply(this,[function(description){var desc=replaceInternalStreamId(_this14,description);args[0].apply(null,[desc])},function(err){if(args[1]){args[1].apply(null,err)}},arguments[2]])}return nativeMethod.apply(this,arguments).then(function(description){return replaceInternalStreamId(_this14,description)})});window.RTCPeerConnection.prototype[method]=methodObj[method]});var origSetLocalDescription=window.RTCPeerConnection.prototype.setLocalDescription;window.RTCPeerConnection.prototype.setLocalDescription=function setLocalDescription(){if(!arguments.length||!arguments[0].type){return origSetLocalDescription.apply(this,arguments)}arguments[0]=replaceExternalStreamId(this,arguments[0]);return origSetLocalDescription.apply(this,arguments)};var origLocalDescription=Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(window.RTCPeerConnection.prototype,"localDescription",{get:function get(){var description=origLocalDescription.get.apply(this);if(description.type===""){return description}return replaceInternalStreamId(this,description)}});window.RTCPeerConnection.prototype.removeTrack=function removeTrack(sender){var _this15=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}if(!sender._pc){throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.","TypeError")}var isLocal=sender._pc===this;if(!isLocal){throw new DOMException("Sender was not created by this connection.","InvalidAccessError")}this._streams=this._streams||{};var stream=void 0;Object.keys(this._streams).forEach(function(streamid){var hasTrack=_this15._streams[streamid].getTracks().find(function(track){return sender.track===track});if(hasTrack){stream=_this15._streams[streamid]}});if(stream){if(stream.getTracks().length===1){this.removeStream(this._reverseStreams[stream.id])}else{stream.removeTrack(sender.track)}this.dispatchEvent(new Event("negotiationneeded"))}}}function shimPeerConnection(window){var browserDetails=utils.detectBrowser(window);if(!window.RTCPeerConnection&&window.webkitRTCPeerConnection){window.RTCPeerConnection=window.webkitRTCPeerConnection}if(!window.RTCPeerConnection){return}if(browserDetails.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){arguments[0]=new(method==="addIceCandidate"?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)});window.RTCPeerConnection.prototype[method]=methodObj[method]})}var nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function addIceCandidate(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if(browserDetails.version<78&&arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return nativeAddIceCandidate.apply(this,arguments)}}function fixNegotiationNeeded(window){utils.wrapPeerConnectionEvent(window,"negotiationneeded",function(e){var pc=e.target;if(pc.signalingState!=="stable"){return}return e})}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window,getSourceId){if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}if(!window.navigator.mediaDevices){return}if(typeof getSourceId!=="function"){console.error("shimGetDisplayMedia: getSourceId argument is not "+"a function");return}window.navigator.mediaDevices.getDisplayMedia=function getDisplayMedia(constraints){return getSourceId(constraints).then(function(sourceId){var widthSpecified=constraints.video&&constraints.video.width;var heightSpecified=constraints.video&&constraints.video.height;var frameRateSpecified=constraints.video&&constraints.video.frameRate;constraints.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId,maxFrameRate:frameRateSpecified||3}};if(widthSpecified){constraints.video.mandatory.maxWidth=widthSpecified}if(heightSpecified){constraints.video.mandatory.maxHeight=heightSpecified}return window.navigator.mediaDevices.getUserMedia(constraints)})}}},{}],5:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=shimGetUserMedia;var _utils=require("../utils.js");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}var logging=utils.log;function shimGetUserMedia(window){var navigator=window&&window.navigator;if(!navigator.mediaDevices){return}var browserDetails=utils.detectBrowser(window);var constraintsToChrome_=function constraintsToChrome_(c){if((typeof c==="undefined"?"undefined":_typeof(c))!=="object"||c.mandatory||c.optional){return c}var cc={};Object.keys(c).forEach(function(key){if(key==="require"||key==="advanced"||key==="mediaSource"){return}var r=_typeof(c[key])==="object"?c[key]:{ideal:c[key]};if(r.exact!==undefined&&typeof r.exact==="number"){r.min=r.max=r.exact}var oldname_=function oldname_(prefix,name){if(prefix){return prefix+name.charAt(0).toUpperCase()+name.slice(1)}return name==="deviceId"?"sourceId":name};if(r.ideal!==undefined){cc.optional=cc.optional||[];var oc={};if(typeof r.ideal==="number"){oc[oldname_("min",key)]=r.ideal;cc.optional.push(oc);oc={};oc[oldname_("max",key)]=r.ideal;cc.optional.push(oc)}else{oc[oldname_("",key)]=r.ideal;cc.optional.push(oc)}}if(r.exact!==undefined&&typeof r.exact!=="number"){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_("",key)]=r.exact}else{["min","max"].forEach(function(mix){if(r[mix]!==undefined){cc.mandatory=cc.mandatory||{};cc.mandatory[oldname_(mix,key)]=r[mix]}})}});if(c.advanced){cc.optional=(cc.optional||[]).concat(c.advanced)}return cc};var shimConstraints_=function shimConstraints_(constraints,func){if(browserDetails.version>=61){return func(constraints)}constraints=JSON.parse(JSON.stringify(constraints));if(constraints&&_typeof(constraints.audio)==="object"){var remap=function remap(obj,a,b){if(a in obj&&!(b in obj)){obj[b]=obj[a];delete obj[a]}};constraints=JSON.parse(JSON.stringify(constraints));remap(constraints.audio,"autoGainControl","googAutoGainControl");remap(constraints.audio,"noiseSuppression","googNoiseSuppression");constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&_typeof(constraints.video)==="object"){var face=constraints.video.facingMode;face=face&&((typeof face==="undefined"?"undefined":_typeof(face))==="object"?face:{ideal:face});var getSupportedFacingModeLies=browserDetails.version<66;if(face&&(face.exact==="user"||face.exact==="environment"||face.ideal==="user"||face.ideal==="environment")&&!(navigator.mediaDevices.getSupportedConstraints&&navigator.mediaDevices.getSupportedConstraints().facingMode&&!getSupportedFacingModeLies)){delete constraints.video.facingMode;var matches=void 0;if(face.exact==="environment"||face.ideal==="environment"){matches=["back","rear"]}else if(face.exact==="user"||face.ideal==="user"){matches=["front"]}if(matches){return navigator.mediaDevices.enumerateDevices().then(function(devices){devices=devices.filter(function(d){return d.kind==="videoinput"});var dev=devices.find(function(d){return matches.some(function(match){return d.label.toLowerCase().includes(match)})});if(!dev&&devices.length&&matches.includes("back")){dev=devices[devices.length-1]}if(dev){constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}}constraints.video=constraintsToChrome_(constraints.video);logging("chrome: "+JSON.stringify(constraints));return func(constraints)})}}constraints.video=constraintsToChrome_(constraints.video)}logging("chrome: "+JSON.stringify(constraints));return func(constraints)};var shimError_=function shimError_(e){if(browserDetails.version>=64){return e}return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function toString(){return this.name+(this.message&&": ")+this.message}}};var getUserMedia_=function getUserMedia_(constraints,onSuccess,onError){shimConstraints_(constraints,function(c){navigator.webkitGetUserMedia(c,onSuccess,function(e){if(onError){onError(shimError_(e))}})})};navigator.getUserMedia=getUserMedia_.bind(navigator);if(navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,function(c){return origGetUserMedia(c).then(function(stream){if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length){stream.getTracks().forEach(function(track){track.stop()});throw new DOMException("","NotFoundError")}return stream},function(e){return Promise.reject(shimError_(e))})})}}}},{"../utils.js":15}],6:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimRTCIceCandidate=shimRTCIceCandidate;exports.shimMaxMessageSize=shimMaxMessageSize;exports.shimSendThrowTypeError=shimSendThrowTypeError;exports.shimConnectionState=shimConnectionState;exports.removeAllowExtmapMixed=removeAllowExtmapMixed;var _sdp=require("sdp");var _sdp2=_interopRequireDefault(_sdp);var _utils=require("./utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function shimRTCIceCandidate(window){if(!window.RTCIceCandidate||window.RTCIceCandidate&&"foundation"in window.RTCIceCandidate.prototype){return}var NativeRTCIceCandidate=window.RTCIceCandidate;window.RTCIceCandidate=function RTCIceCandidate(args){if((typeof args==="undefined"?"undefined":_typeof(args))==="object"&&args.candidate&&args.candidate.indexOf("a=")===0){args=JSON.parse(JSON.stringify(args));args.candidate=args.candidate.substr(2)}if(args.candidate&&args.candidate.length){var nativeCandidate=new NativeRTCIceCandidate(args);var parsedCandidate=_sdp2.default.parseCandidate(args.candidate);var augmentedCandidate=Object.assign(nativeCandidate,parsedCandidate);augmentedCandidate.toJSON=function toJSON(){return{candidate:augmentedCandidate.candidate,sdpMid:augmentedCandidate.sdpMid,sdpMLineIndex:augmentedCandidate.sdpMLineIndex,usernameFragment:augmentedCandidate.usernameFragment}};return augmentedCandidate}return new NativeRTCIceCandidate(args)};window.RTCIceCandidate.prototype=NativeRTCIceCandidate.prototype;utils.wrapPeerConnectionEvent(window,"icecandidate",function(e){if(e.candidate){Object.defineProperty(e,"candidate",{value:new window.RTCIceCandidate(e.candidate),writable:"false"})}return e})}function shimMaxMessageSize(window){if(!window.RTCPeerConnection){return}var browserDetails=utils.detectBrowser(window);if(!("sctp"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"sctp",{get:function get(){return typeof this._sctp==="undefined"?null:this._sctp}})}var sctpInDescription=function sctpInDescription(description){if(!description||!description.sdp){return false}var sections=_sdp2.default.splitSections(description.sdp);sections.shift();return sections.some(function(mediaSection){var mLine=_sdp2.default.parseMLine(mediaSection);return mLine&&mLine.kind==="application"&&mLine.protocol.indexOf("SCTP")!==-1})};var getRemoteFirefoxVersion=function getRemoteFirefoxVersion(description){var match=description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(match===null||match.length<2){return-1}var version=parseInt(match[1],10);return version!==version?-1:version};var getCanSendMaxMessageSize=function getCanSendMaxMessageSize(remoteIsFirefox){var canSendMaxMessageSize=65536;if(browserDetails.browser==="firefox"){if(browserDetails.version<57){if(remoteIsFirefox===-1){canSendMaxMessageSize=16384}else{canSendMaxMessageSize=2147483637}}else if(browserDetails.version<60){canSendMaxMessageSize=browserDetails.version===57?65535:65536}else{canSendMaxMessageSize=2147483637}}return canSendMaxMessageSize};var getMaxMessageSize=function getMaxMessageSize(description,remoteIsFirefox){var maxMessageSize=65536;if(browserDetails.browser==="firefox"&&browserDetails.version===57){maxMessageSize=65535}var match=_sdp2.default.matchPrefix(description.sdp,"a=max-message-size:");if(match.length>0){maxMessageSize=parseInt(match[0].substr(19),10)}else if(browserDetails.browser==="firefox"&&remoteIsFirefox!==-1){maxMessageSize=2147483637}return maxMessageSize};var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){this._sctp=null;if(browserDetails.browser==="chrome"&&browserDetails.version>=76){var _getConfiguration=this.getConfiguration(),sdpSemantics=_getConfiguration.sdpSemantics;if(sdpSemantics==="plan-b"){Object.defineProperty(this,"sctp",{get:function get(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:true,configurable:true})}}if(sctpInDescription(arguments[0])){var isFirefox=getRemoteFirefoxVersion(arguments[0]);var canSendMMS=getCanSendMaxMessageSize(isFirefox);var remoteMMS=getMaxMessageSize(arguments[0],isFirefox);var maxMessageSize=void 0;if(canSendMMS===0&&remoteMMS===0){maxMessageSize=Number.POSITIVE_INFINITY}else if(canSendMMS===0||remoteMMS===0){maxMessageSize=Math.max(canSendMMS,remoteMMS)}else{maxMessageSize=Math.min(canSendMMS,remoteMMS)}var sctp={};Object.defineProperty(sctp,"maxMessageSize",{get:function get(){return maxMessageSize}});this._sctp=sctp}return origSetRemoteDescription.apply(this,arguments)}}function shimSendThrowTypeError(window){if(!(window.RTCPeerConnection&&"createDataChannel"in window.RTCPeerConnection.prototype)){return}function wrapDcSend(dc,pc){var origDataChannelSend=dc.send;dc.send=function send(){var data=arguments[0];var length=data.length||data.size||data.byteLength;if(dc.readyState==="open"&&pc.sctp&&length>pc.sctp.maxMessageSize){throw new TypeError("Message too large (can send a maximum of "+pc.sctp.maxMessageSize+" bytes)")}return origDataChannelSend.apply(dc,arguments)}}var origCreateDataChannel=window.RTCPeerConnection.prototype.createDataChannel;window.RTCPeerConnection.prototype.createDataChannel=function createDataChannel(){var dataChannel=origCreateDataChannel.apply(this,arguments);wrapDcSend(dataChannel,this);return dataChannel};utils.wrapPeerConnectionEvent(window,"datachannel",function(e){wrapDcSend(e.channel,e.target);return e})}function shimConnectionState(window){if(!window.RTCPeerConnection||"connectionState"in window.RTCPeerConnection.prototype){return}var proto=window.RTCPeerConnection.prototype;Object.defineProperty(proto,"connectionState",{get:function get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:true,configurable:true});Object.defineProperty(proto,"onconnectionstatechange",{get:function get(){return this._onconnectionstatechange||null},set:function set(cb){if(this._onconnectionstatechange){this.removeEventListener("connectionstatechange",this._onconnectionstatechange);delete this._onconnectionstatechange}if(cb){this.addEventListener("connectionstatechange",this._onconnectionstatechange=cb)}},enumerable:true,configurable:true});["setLocalDescription","setRemoteDescription"].forEach(function(method){var origMethod=proto[method];proto[method]=function(){if(!this._connectionstatechangepoly){this._connectionstatechangepoly=function(e){var pc=e.target;if(pc._lastConnectionState!==pc.connectionState){pc._lastConnectionState=pc.connectionState;var newEvent=new Event("connectionstatechange",e);pc.dispatchEvent(newEvent)}return e};this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)}return origMethod.apply(this,arguments)}})}function removeAllowExtmapMixed(window){if(!window.RTCPeerConnection){return}var browserDetails=utils.detectBrowser(window);if(browserDetails.browser==="chrome"&&browserDetails.version>=71){return}var nativeSRD=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(desc){if(desc&&desc.sdp&&desc.sdp.indexOf("\na=extmap-allow-mixed")!==-1){desc.sdp=desc.sdp.split("\n").filter(function(line){return line.trim()!=="a=extmap-allow-mixed"}).join("\n")}return nativeSRD.apply(this,arguments)}}},{"./utils":15,sdp:17}],7:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimPeerConnection=shimPeerConnection;exports.shimReplaceTrack=shimReplaceTrack;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);var _filtericeservers=require("./filtericeservers");var _rtcpeerconnectionShim=require("rtcpeerconnection-shim");var _rtcpeerconnectionShim2=_interopRequireDefault(_rtcpeerconnectionShim);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimPeerConnection(window){var browserDetails=utils.detectBrowser(window);if(window.RTCIceGatherer){if(!window.RTCIceCandidate){window.RTCIceCandidate=function RTCIceCandidate(args){return args}}if(!window.RTCSessionDescription){window.RTCSessionDescription=function RTCSessionDescription(args){return args}}if(browserDetails.version<15025){var origMSTEnabled=Object.getOwnPropertyDescriptor(window.MediaStreamTrack.prototype,"enabled");Object.defineProperty(window.MediaStreamTrack.prototype,"enabled",{set:function set(value){origMSTEnabled.set.call(this,value);var ev=new Event("enabled");ev.enabled=value;this.dispatchEvent(ev)}})}}if(window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function get(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=new window.RTCDtmfSender(this)}else if(this.track.kind==="video"){this._dtmf=null}}return this._dtmf}})}if(window.RTCDtmfSender&&!window.RTCDTMFSender){window.RTCDTMFSender=window.RTCDtmfSender}var RTCPeerConnectionShim=(0,_rtcpeerconnectionShim2.default)(window,browserDetails.version);window.RTCPeerConnection=function RTCPeerConnection(config){if(config&&config.iceServers){config.iceServers=(0,_filtericeservers.filterIceServers)(config.iceServers,browserDetails.version);utils.log("ICE servers after filtering:",config.iceServers)}return new RTCPeerConnectionShim(config)};window.RTCPeerConnection.prototype=RTCPeerConnectionShim.prototype}function shimReplaceTrack(window){if(window.RTCRtpSender&&!("replaceTrack"in window.RTCRtpSender.prototype)){window.RTCRtpSender.prototype.replaceTrack=window.RTCRtpSender.prototype.setTrack}}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.filterIceServers=filterIceServers;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){utils.deprecated("RTCIceServer.url","RTCIceServer.urls")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){if(url.indexOf("stun:")===0){return false}var validTurn=url.startsWith("turn")&&!url.startsWith("turn:[")&&url.includes("transport=udp");if(validTurn&&!hasTurn){hasTurn=true;return true}return validTurn&&!hasTurn});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}})}},{"../utils":15}],9:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window){if(!("getDisplayMedia"in window.navigator)){return}if(!window.navigator.mediaDevices){return}if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}window.navigator.mediaDevices.getDisplayMedia=window.navigator.getDisplayMedia.bind(window.navigator)}},{}],10:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetUserMedia=shimGetUserMedia;function shimGetUserMedia(window){var navigator=window&&window.navigator;var shimError_=function shimError_(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function toString(){return this.name}}};var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(shimError_(e))})}}},{}],11:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=exports.shimGetUserMedia=undefined;var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:true,get:function get(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:true,get:function get(){return _getdisplaymedia.shimGetDisplayMedia}});exports.shimOnTrack=shimOnTrack;exports.shimPeerConnection=shimPeerConnection;exports.shimSenderGetStats=shimSenderGetStats;exports.shimReceiverGetStats=shimReceiverGetStats;exports.shimRemoveStream=shimRemoveStream;exports.shimRTCDataChannel=shimRTCDataChannel;exports.shimAddTransceiver=shimAddTransceiver;exports.shimCreateOffer=shimCreateOffer;exports.shimCreateAnswer=shimCreateAnswer;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function shimOnTrack(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)){Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function get(){return{receiver:this.receiver}}})}}function shimPeerConnection(window){var browserDetails=utils.detectBrowser(window);if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!(window.RTCPeerConnection||window.mozRTCPeerConnection)){return}if(!window.RTCPeerConnection&&window.mozRTCPeerConnection){window.RTCPeerConnection=window.mozRTCPeerConnection}if(browserDetails.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method];var methodObj=_defineProperty({},method,function(){arguments[0]=new(method==="addIceCandidate"?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]);return nativeMethod.apply(this,arguments)});window.RTCPeerConnection.prototype[method]=methodObj[method]})}if(browserDetails.version<68){var nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function addIceCandidate(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if(arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return nativeAddIceCandidate.apply(this,arguments)}}var modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};var nativeGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function getStats(){var _arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];return nativeGetStats.apply(this,[selector||null]).then(function(stats){if(browserDetails.version<53&&!onSucc){try{stats.forEach(function(stat){stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if(e.name!=="TypeError"){throw e}stats.forEach(function(stat,i){stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}}return stats}).then(onSucc,onErr)}}function shimSenderGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender)){return}if(window.RTCRtpSender&&"getStats"in window.RTCRtpSender.prototype){return}var origGetSenders=window.RTCPeerConnection.prototype.getSenders;if(origGetSenders){window.RTCPeerConnection.prototype.getSenders=function getSenders(){var _this=this;var senders=origGetSenders.apply(this,[]);senders.forEach(function(sender){return sender._pc=_this});return senders}}var origAddTrack=window.RTCPeerConnection.prototype.addTrack;if(origAddTrack){window.RTCPeerConnection.prototype.addTrack=function addTrack(){var sender=origAddTrack.apply(this,arguments);sender._pc=this;return sender}}window.RTCRtpSender.prototype.getStats=function getStats(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection&&window.RTCRtpSender)){return}if(window.RTCRtpSender&&"getStats"in window.RTCRtpReceiver.prototype){return}var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;if(origGetReceivers){window.RTCPeerConnection.prototype.getReceivers=function getReceivers(){var _this2=this;var receivers=origGetReceivers.apply(this,[]);receivers.forEach(function(receiver){return receiver._pc=_this2});return receivers}}utils.wrapPeerConnectionEvent(window,"track",function(e){e.receiver._pc=e.srcElement;return e});window.RTCRtpReceiver.prototype.getStats=function getStats(){return this._pc.getStats(this.track)}}function shimRemoveStream(window){if(!window.RTCPeerConnection||"removeStream"in window.RTCPeerConnection.prototype){return}window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this3=this;utils.deprecated("removeStream","removeTrack");this.getSenders().forEach(function(sender){if(sender.track&&stream.getTracks().includes(sender.track)){_this3.removeTrack(sender)}})}}function shimRTCDataChannel(window){if(window.DataChannel&&!window.RTCDataChannel){window.RTCDataChannel=window.DataChannel}}function shimAddTransceiver(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origAddTransceiver=window.RTCPeerConnection.prototype.addTransceiver;if(origAddTransceiver){window.RTCPeerConnection.prototype.addTransceiver=function addTransceiver(){this.setParametersPromises=[];var initParameters=arguments[1];var shouldPerformCheck=initParameters&&"sendEncodings"in initParameters;if(shouldPerformCheck){initParameters.sendEncodings.forEach(function(encodingParam){if("rid"in encodingParam){var ridRegex=/^[a-z0-9]{0,16}$/i;if(!ridRegex.test(encodingParam.rid)){throw new TypeError("Invalid RID value provided.")}}if("scaleResolutionDownBy"in encodingParam){if(!(parseFloat(encodingParam.scaleResolutionDownBy)>=1)){throw new RangeError("scale_resolution_down_by must be >= 1.0")}}if("maxFramerate"in encodingParam){if(!(parseFloat(encodingParam.maxFramerate)>=0)){throw new RangeError("max_framerate must be >= 0.0")}}})}var transceiver=origAddTransceiver.apply(this,arguments);if(shouldPerformCheck){var sender=transceiver.sender;var params=sender.getParameters();if(!("encodings"in params)){params.encodings=initParameters.sendEncodings;this.setParametersPromises.push(sender.setParameters(params).catch(function(){}))}}return transceiver}}}function shimCreateOffer(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function createOffer(){var _this4=this,_arguments2=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return origCreateOffer.apply(_this4,_arguments2)}).finally(function(){_this4.setParametersPromises=[]})}return origCreateOffer.apply(this,arguments)}}function shimCreateAnswer(window){if(!((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCPeerConnection)){return}var origCreateAnswer=window.RTCPeerConnection.prototype.createAnswer;window.RTCPeerConnection.prototype.createAnswer=function createAnswer(){var _this5=this,_arguments3=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return origCreateAnswer.apply(_this5,_arguments3)}).finally(function(){_this5.setParametersPromises=[]})}return origCreateAnswer.apply(this,arguments)}}},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});exports.shimGetDisplayMedia=shimGetDisplayMedia;function shimGetDisplayMedia(window,preferredMediaSource){if(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices){return}if(!window.navigator.mediaDevices){return}window.navigator.mediaDevices.getDisplayMedia=function getDisplayMedia(constraints){if(!(constraints&&constraints.video)){var err=new DOMException("getDisplayMedia without video "+"constraints is undefined");err.name="NotFoundError";err.code=8;return Promise.reject(err)}if(constraints.video===true){constraints.video={mediaSource:preferredMediaSource}}else{constraints.video.mediaSource=preferredMediaSource}return window.navigator.mediaDevices.getUserMedia(constraints)}}},{}],13:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=shimGetUserMedia;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimGetUserMedia(window){var browserDetails=utils.detectBrowser(window);var navigator=window&&window.navigator;var MediaStreamTrack=window&&window.MediaStreamTrack;navigator.getUserMedia=function(constraints,onSuccess,onError){utils.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)};if(!(browserDetails.version>55&&"autoGainControl"in navigator.mediaDevices.getSupportedConstraints())){var remap=function remap(obj,a,b){if(a in obj&&!(b in obj)){obj[b]=obj[a];delete obj[a]}};var nativeGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){if((typeof c==="undefined"?"undefined":_typeof(c))==="object"&&_typeof(c.audio)==="object"){c=JSON.parse(JSON.stringify(c));remap(c.audio,"autoGainControl","mozAutoGainControl");remap(c.audio,"noiseSuppression","mozNoiseSuppression")}return nativeGetUserMedia(c)};if(MediaStreamTrack&&MediaStreamTrack.prototype.getSettings){var nativeGetSettings=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){var obj=nativeGetSettings.apply(this,arguments);remap(obj,"mozAutoGainControl","autoGainControl");remap(obj,"mozNoiseSuppression","noiseSuppression");return obj}}if(MediaStreamTrack&&MediaStreamTrack.prototype.applyConstraints){var nativeApplyConstraints=MediaStreamTrack.prototype.applyConstraints;MediaStreamTrack.prototype.applyConstraints=function(c){if(this.kind==="audio"&&(typeof c==="undefined"?"undefined":_typeof(c))==="object"){c=JSON.parse(JSON.stringify(c));remap(c,"autoGainControl","mozAutoGainControl");remap(c,"noiseSuppression","mozNoiseSuppression")}return nativeApplyConstraints.apply(this,[c])}}}}},{"../utils":15}],14:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimLocalStreamsAPI=shimLocalStreamsAPI;exports.shimRemoteStreamsAPI=shimRemoteStreamsAPI;exports.shimCallbacksAPI=shimCallbacksAPI;exports.shimGetUserMedia=shimGetUserMedia;exports.shimConstraints=shimConstraints;exports.shimRTCIceServerUrls=shimRTCIceServerUrls;exports.shimTrackEventTransceiver=shimTrackEventTransceiver;exports.shimCreateOfferLegacy=shimCreateOfferLegacy;var _utils=require("../utils");var utils=_interopRequireWildcard(_utils);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function shimLocalStreamsAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}if(!("getLocalStreams"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.getLocalStreams=function getLocalStreams(){if(!this._localStreams){this._localStreams=[]}return this._localStreams}}if(!("addStream"in window.RTCPeerConnection.prototype)){var _addTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addStream=function addStream(stream){var _this=this;if(!this._localStreams){this._localStreams=[]}if(!this._localStreams.includes(stream)){this._localStreams.push(stream)}stream.getAudioTracks().forEach(function(track){return _addTrack.call(_this,track,stream)});stream.getVideoTracks().forEach(function(track){return _addTrack.call(_this,track,stream)})};window.RTCPeerConnection.prototype.addTrack=function addTrack(track){var stream=arguments[1];if(stream){if(!this._localStreams){this._localStreams=[stream]}else if(!this._localStreams.includes(stream)){this._localStreams.push(stream)}}return _addTrack.apply(this,arguments)}}if(!("removeStream"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.removeStream=function removeStream(stream){var _this2=this;if(!this._localStreams){this._localStreams=[]}var index=this._localStreams.indexOf(stream);if(index===-1){return}this._localStreams.splice(index,1);var tracks=stream.getTracks();this.getSenders().forEach(function(sender){if(tracks.includes(sender.track)){_this2.removeTrack(sender)}})}}}function shimRemoteStreamsAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}if(!("getRemoteStreams"in window.RTCPeerConnection.prototype)){window.RTCPeerConnection.prototype.getRemoteStreams=function getRemoteStreams(){return this._remoteStreams?this._remoteStreams:[]}}if(!("onaddstream"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get:function get(){return this._onaddstream},set:function set(f){var _this3=this;if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=f);this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(!_this3._remoteStreams){_this3._remoteStreams=[]}if(_this3._remoteStreams.includes(stream)){return}_this3._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;_this3.dispatchEvent(event)})})}});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function setRemoteDescription(){var pc=this;if(!this._onaddstreampoly){this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(!pc._remoteStreams){pc._remoteStreams=[]}if(pc._remoteStreams.indexOf(stream)>=0){return}pc._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;pc.dispatchEvent(event)})})}return origSetRemoteDescription.apply(pc,arguments)}}}function shimCallbacksAPI(window){if((typeof window==="undefined"?"undefined":_typeof(window))!=="object"||!window.RTCPeerConnection){return}var prototype=window.RTCPeerConnection.prototype;var origCreateOffer=prototype.createOffer;var origCreateAnswer=prototype.createAnswer;var setLocalDescription=prototype.setLocalDescription;var setRemoteDescription=prototype.setRemoteDescription;var addIceCandidate=prototype.addIceCandidate;prototype.createOffer=function createOffer(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0];var promise=origCreateOffer.apply(this,[options]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.createAnswer=function createAnswer(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0];var promise=origCreateAnswer.apply(this,[options]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};var withCallback=function withCallback(description,successCallback,failureCallback){var promise=setLocalDescription.apply(this,[description]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.setLocalDescription=withCallback;withCallback=function withCallback(description,successCallback,failureCallback){var promise=setRemoteDescription.apply(this,[description]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.setRemoteDescription=withCallback;withCallback=function withCallback(candidate,successCallback,failureCallback){var promise=addIceCandidate.apply(this,[candidate]);if(!failureCallback){return promise}promise.then(successCallback,failureCallback);return Promise.resolve()};prototype.addIceCandidate=withCallback}function shimGetUserMedia(window){var navigator=window&&window.navigator;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var mediaDevices=navigator.mediaDevices;var _getUserMedia=mediaDevices.getUserMedia.bind(mediaDevices);navigator.mediaDevices.getUserMedia=function(constraints){return _getUserMedia(shimConstraints(constraints))}}if(!navigator.getUserMedia&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){navigator.getUserMedia=function getUserMedia(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}.bind(navigator)}}function shimConstraints(constraints){if(constraints&&constraints.video!==undefined){return Object.assign({},constraints,{video:utils.compactObject(constraints.video)})}return constraints}function shimRTCIceServerUrls(window){var OrigPeerConnection=window.RTCPeerConnection;window.RTCPeerConnection=function RTCPeerConnection(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){var newIceServers=[];for(var i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];if(!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")){utils.deprecated("RTCIceServer.url","RTCIceServer.urls");server=JSON.parse(JSON.stringify(server));server.urls=server.url;delete server.url;newIceServers.push(server)}else{newIceServers.push(pcConfig.iceServers[i])}}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)};window.RTCPeerConnection.prototype=OrigPeerConnection.prototype;if("generateCertificate"in window.RTCPeerConnection){Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function get(){return OrigPeerConnection.generateCertificate}})}}function shimTrackEventTransceiver(window){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)){Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function get(){return{receiver:this.receiver}}})}}function shimCreateOfferLegacy(window){var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function createOffer(offerOptions){if(offerOptions){if(typeof offerOptions.offerToReceiveAudio!=="undefined"){offerOptions.offerToReceiveAudio=!!offerOptions.offerToReceiveAudio}var audioTransceiver=this.getTransceivers().find(function(transceiver){return transceiver.receiver.track.kind==="audio"});if(offerOptions.offerToReceiveAudio===false&&audioTransceiver){if(audioTransceiver.direction==="sendrecv"){if(audioTransceiver.setDirection){audioTransceiver.setDirection("sendonly")}else{audioTransceiver.direction="sendonly"}}else if(audioTransceiver.direction==="recvonly"){if(audioTransceiver.setDirection){audioTransceiver.setDirection("inactive")}else{audioTransceiver.direction="inactive"}}}else if(offerOptions.offerToReceiveAudio===true&&!audioTransceiver){this.addTransceiver("audio")}if(typeof offerOptions.offerToReceiveVideo!=="undefined"){offerOptions.offerToReceiveVideo=!!offerOptions.offerToReceiveVideo}var videoTransceiver=this.getTransceivers().find(function(transceiver){return transceiver.receiver.track.kind==="video"});if(offerOptions.offerToReceiveVideo===false&&videoTransceiver){if(videoTransceiver.direction==="sendrecv"){if(videoTransceiver.setDirection){videoTransceiver.setDirection("sendonly")}else{videoTransceiver.direction="sendonly"}}else if(videoTransceiver.direction==="recvonly"){if(videoTransceiver.setDirection){videoTransceiver.setDirection("inactive")}else{videoTransceiver.direction="inactive"}}}else if(offerOptions.offerToReceiveVideo===true&&!videoTransceiver){this.addTransceiver("video")}}return origCreateOffer.apply(this,arguments)}}},{"../utils":15}],15:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:true});var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.extractVersion=extractVersion;exports.wrapPeerConnectionEvent=wrapPeerConnectionEvent;exports.disableLog=disableLog;exports.disableWarnings=disableWarnings;exports.log=log;exports.deprecated=deprecated;exports.detectBrowser=detectBrowser;exports.compactObject=compactObject;exports.walkStats=walkStats;exports.filterStats=filterStats;function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var logDisabled_=true;var deprecationWarnings_=true;function extractVersion(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}function wrapPeerConnectionEvent(window,eventNameToWrap,wrapper){if(!window.RTCPeerConnection){return}var proto=window.RTCPeerConnection.prototype;var nativeAddEventListener=proto.addEventListener;proto.addEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap){return nativeAddEventListener.apply(this,arguments)}var wrappedCallback=function wrappedCallback(e){var modifiedEvent=wrapper(e);if(modifiedEvent){cb(modifiedEvent)}};this._eventMap=this._eventMap||{};this._eventMap[cb]=wrappedCallback;return nativeAddEventListener.apply(this,[nativeEventName,wrappedCallback])};var nativeRemoveEventListener=proto.removeEventListener;proto.removeEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap||!this._eventMap||!this._eventMap[cb]){return nativeRemoveEventListener.apply(this,arguments)}var unwrappedCb=this._eventMap[cb];delete this._eventMap[cb];return nativeRemoveEventListener.apply(this,[nativeEventName,unwrappedCb])};Object.defineProperty(proto,"on"+eventNameToWrap,{get:function get(){return this["_on"+eventNameToWrap]},set:function set(cb){if(this["_on"+eventNameToWrap]){this.removeEventListener(eventNameToWrap,this["_on"+eventNameToWrap]);delete this["_on"+eventNameToWrap]}if(cb){this.addEventListener(eventNameToWrap,this["_on"+eventNameToWrap]=cb)}},enumerable:true,configurable:true})}function disableLog(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+(typeof bool==="undefined"?"undefined":_typeof(bool))+". Please use a boolean.")}logDisabled_=bool;return bool?"adapter.js logging disabled":"adapter.js logging enabled"}function disableWarnings(bool){if(typeof bool!=="boolean"){return new Error("Argument type: "+(typeof bool==="undefined"?"undefined":_typeof(bool))+". Please use a boolean.")}deprecationWarnings_=!bool;return"adapter.js deprecation warnings "+(bool?"disabled":"enabled")}function log(){if((typeof window==="undefined"?"undefined":_typeof(window))==="object"){if(logDisabled_){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}}function deprecated(oldMethod,newMethod){if(!deprecationWarnings_){return}console.warn(oldMethod+" is deprecated, please use "+newMethod+" instead.")}function detectBrowser(window){var navigator=window.navigator;var result={browser:null,version:null};if(typeof window==="undefined"||!window.navigator){result.browser="Not a browser.";return result}if(navigator.mozGetUserMedia){result.browser="firefox";result.version=extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1)}else if(navigator.webkitGetUserMedia||window.isSecureContext===false&&window.webkitRTCPeerConnection&&!window.RTCIceGatherer){result.browser="chrome";result.version=extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){result.browser="edge";result.version=extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}else if(window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)){result.browser="safari";result.version=extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1);result.supportsUnifiedPlan=window.RTCRtpTransceiver&&"currentDirection"in window.RTCRtpTransceiver.prototype}else{result.browser="Not a supported browser.";return result}return result}function isObject(val){return Object.prototype.toString.call(val)==="[object Object]"}function compactObject(data){if(!isObject(data)){return data}return Object.keys(data).reduce(function(accumulator,key){var isObj=isObject(data[key]);var value=isObj?compactObject(data[key]):data[key];var isEmptyObject=isObj&&!Object.keys(value).length;if(value===undefined||isEmptyObject){return accumulator}return Object.assign(accumulator,_defineProperty({},key,value))},{})}function walkStats(stats,base,resultSet){if(!base||resultSet.has(base.id)){return}resultSet.set(base.id,base);Object.keys(base).forEach(function(name){if(name.endsWith("Id")){walkStats(stats,stats.get(base[name]),resultSet)}else if(name.endsWith("Ids")){base[name].forEach(function(id){walkStats(stats,stats.get(id),resultSet)})}})}function filterStats(result,track,outbound){var streamStatsType=outbound?"outbound-rtp":"inbound-rtp";var filteredResult=new Map;if(track===null){return filteredResult}var trackStats=[];result.forEach(function(value){if(value.type==="track"&&value.trackIdentifier===track.id){trackStats.push(value)}});trackStats.forEach(function(trackStat){result.forEach(function(stats){if(stats.type===streamStatsType&&stats.trackId===trackStat.id){walkStats(result,stats,filteredResult)}})});return filteredResult}},{}],16:[function(require,module,exports){var SDPUtils=require("sdp");function fixStatsType(stat){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[stat.type]||stat.type}function writeMediaSection(transceiver,caps,type,stream,dtlsRole){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":dtlsRole||"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var trackId=transceiver.rtpSender._initialTrackId||transceiver.rtpSender.track.id;transceiver.rtpSender._initialTrackId=trackId;var msid="msid:"+(stream?stream.id:"-")+" "+trackId+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){var validTurn=url.indexOf("turn:")===0&&url.indexOf("transport=udp")!==-1&&url.indexOf("turn:[")===-1&&!hasTurn;if(validTurn){hasTurn=true;return true}return url.indexOf("stun:")===0&&edgeVersion>=14393&&url.indexOf("?transport=udp")===-1});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}})}function getCommonCapabilities(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};var findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++){if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt){return codecs[i]}}};var rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs);var rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if(lCodec.name.toLowerCase()==="rtx"&&lCodec.parameters&&rCodec.parameters.apt){if(!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs)){continue}}rCodec=JSON.parse(JSON.stringify(rCodec));rCodec.numChannels=Math.min(lCodec.numChannels,rCodec.numChannels);commonCapabilities.codecs.push(rCodec);rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter(function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++){if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter){return true}}return false});break}}});localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}});return commonCapabilities}function isActionAllowedInSignalingState(action,type,signalingState){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[type][action].indexOf(signalingState)!==-1}function maybeAddCandidate(iceTransport,candidate){var alreadyAdded=iceTransport.getRemoteCandidates().find(function(remoteCandidate){return candidate.foundation===remoteCandidate.foundation&&candidate.ip===remoteCandidate.ip&&candidate.port===remoteCandidate.port&&candidate.priority===remoteCandidate.priority&&candidate.protocol===remoteCandidate.protocol&&candidate.type===remoteCandidate.type});if(!alreadyAdded){iceTransport.addRemoteCandidate(candidate)}return!alreadyAdded}function makeError(name,description){var e=new Error(description);e.name=name;e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:undefined,OperationError:undefined}[name];return e}module.exports=function(window,edgeVersion){function addTrackToStreamAndFireEvent(track,stream){stream.addTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("addtrack",{track:track}))}function removeTrackFromStreamAndFireEvent(track,stream){stream.removeTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("removetrack",{track:track}))}function fireAddTrack(pc,track,receiver,streams){var trackEvent=new Event("track");trackEvent.track=track;trackEvent.receiver=receiver;trackEvent.transceiver={receiver:receiver};trackEvent.streams=streams;window.setTimeout(function(){pc._dispatchEvent("track",trackEvent)})}var RTCPeerConnection=function(config){var pc=this;var _eventTarget=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){pc[method]=_eventTarget[method].bind(_eventTarget)});this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this._localDescription=null;this._remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.connectionState="new";this.iceGatheringState="new";config=JSON.parse(JSON.stringify(config||{}));this.usingBundle=config.bundlePolicy==="max-bundle";if(config.rtcpMuxPolicy==="negotiate"){throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported")}else if(!config.rtcpMuxPolicy){config.rtcpMuxPolicy="require"}switch(config.iceTransportPolicy){case"all":case"relay":break;default:config.iceTransportPolicy="all";break}switch(config.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:config.bundlePolicy="balanced";break}config.iceServers=filterIceServers(config.iceServers||[],edgeVersion);this._iceGatherers=[];if(config.iceCandidatePoolSize){for(var i=config.iceCandidatePoolSize;i>0;i--){this._iceGatherers.push(new window.RTCIceGatherer({iceServers:config.iceServers,gatherPolicy:config.iceTransportPolicy}))}}else{config.iceCandidatePoolSize=0}this._config=config;this.transceivers=[];this._sdpSessionId=SDPUtils.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=undefined;this._isClosed=false};Object.defineProperty(RTCPeerConnection.prototype,"localDescription",{configurable:true,get:function(){return this._localDescription}});Object.defineProperty(RTCPeerConnection.prototype,"remoteDescription",{configurable:true,get:function(){return this._remoteDescription}});RTCPeerConnection.prototype.onicecandidate=null;RTCPeerConnection.prototype.onaddstream=null;RTCPeerConnection.prototype.ontrack=null;RTCPeerConnection.prototype.onremovestream=null;RTCPeerConnection.prototype.onsignalingstatechange=null;RTCPeerConnection.prototype.oniceconnectionstatechange=null;RTCPeerConnection.prototype.onconnectionstatechange=null;RTCPeerConnection.prototype.onicegatheringstatechange=null;RTCPeerConnection.prototype.onnegotiationneeded=null;RTCPeerConnection.prototype.ondatachannel=null;RTCPeerConnection.prototype._dispatchEvent=function(name,event){if(this._isClosed){return}this.dispatchEvent(event);if(typeof this["on"+name]==="function"){this["on"+name](event)}};RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",event)};RTCPeerConnection.prototype.getConfiguration=function(){return this._config};RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams};RTCPeerConnection.prototype._createTransceiver=function(kind,doNotAdd){var hasBundleTransport=this.transceivers.length>0;var transceiver={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:kind,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&hasBundleTransport){transceiver.iceTransport=this.transceivers[0].iceTransport;transceiver.dtlsTransport=this.transceivers[0].dtlsTransport}else{var transports=this._createIceAndDtlsTransports();transceiver.iceTransport=transports.iceTransport;transceiver.dtlsTransport=transports.dtlsTransport}if(!doNotAdd){this.transceivers.push(transceiver)}return transceiver};RTCPeerConnection.prototype.addTrack=function(track,stream){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.")}var alreadyExists=this.transceivers.find(function(s){return s.track===track});if(alreadyExists){throw makeError("InvalidAccessError","Track already exists.")}var transceiver;for(var i=0;i<this.transceivers.length;i++){if(!this.transceivers[i].track&&this.transceivers[i].kind===track.kind){transceiver=this.transceivers[i]}}if(!transceiver){transceiver=this._createTransceiver(track.kind)}this._maybeFireNegotiationNeeded();if(this.localStreams.indexOf(stream)===-1){this.localStreams.push(stream)}transceiver.track=track;transceiver.stream=stream;transceiver.rtpSender=new window.RTCRtpSender(track,transceiver.dtlsTransport);return transceiver.rtpSender};RTCPeerConnection.prototype.addStream=function(stream){var pc=this;if(edgeVersion>=15025){stream.getTracks().forEach(function(track){pc.addTrack(track,stream)})}else{var clonedStream=stream.clone();stream.getTracks().forEach(function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",function(event){clonedTrack.enabled=event.enabled})});clonedStream.getTracks().forEach(function(track){pc.addTrack(track,clonedStream)})}};RTCPeerConnection.prototype.removeTrack=function(sender){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.")}if(!(sender instanceof window.RTCRtpSender)){throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.")}var transceiver=this.transceivers.find(function(t){return t.rtpSender===sender});if(!transceiver){throw makeError("InvalidAccessError","Sender was not created by this connection.")}var stream=transceiver.stream;transceiver.rtpSender.stop();transceiver.rtpSender=null;transceiver.track=null;transceiver.stream=null;var localStreams=this.transceivers.map(function(t){return t.stream});if(localStreams.indexOf(stream)===-1&&this.localStreams.indexOf(stream)>-1){this.localStreams.splice(this.localStreams.indexOf(stream),1)}this._maybeFireNegotiationNeeded()};RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;stream.getTracks().forEach(function(track){var sender=pc.getSenders().find(function(s){return s.track===track});if(sender){pc.removeTrack(sender)}})};RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})};RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})};RTCPeerConnection.prototype._createIceGatherer=function(sdpMLineIndex,usingBundle){var pc=this;if(usingBundle&&sdpMLineIndex>0){return this.transceivers[0].iceGatherer}else if(this._iceGatherers.length){return this._iceGatherers.shift()}var iceGatherer=new window.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(iceGatherer,"state",{value:"new",writable:true});this.transceivers[sdpMLineIndex].bufferedCandidateEvents=[];this.transceivers[sdpMLineIndex].bufferCandidates=function(event){var end=!event.candidate||Object.keys(event.candidate).length===0;iceGatherer.state=end?"completed":"gathering";if(pc.transceivers[sdpMLineIndex].bufferedCandidateEvents!==null){pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event)}};iceGatherer.addEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);return iceGatherer};RTCPeerConnection.prototype._gather=function(mid,sdpMLineIndex){var pc=this;var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer.onlocalcandidate){return}var bufferedCandidateEvents=this.transceivers[sdpMLineIndex].bufferedCandidateEvents;this.transceivers[sdpMLineIndex].bufferedCandidateEvents=null;iceGatherer.removeEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);iceGatherer.onlocalcandidate=function(evt){if(pc.usingBundle&&sdpMLineIndex>0){return}var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;var end=!cand||Object.keys(cand).length===0;if(end){if(iceGatherer.state==="new"||iceGatherer.state==="gathering"){iceGatherer.state="completed"}}else{if(iceGatherer.state==="new"){iceGatherer.state="gathering"}cand.component=1;cand.ufrag=iceGatherer.getLocalParameters().usernameFragment;var serializedCandidate=SDPUtils.writeCandidate(cand);event.candidate=Object.assign(event.candidate,SDPUtils.parseCandidate(serializedCandidate));event.candidate.candidate=serializedCandidate;event.candidate.toJSON=function(){return{candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex,usernameFragment:event.candidate.usernameFragment}}}var sections=SDPUtils.getMediaSections(pc._localDescription.sdp);if(!end){sections[event.candidate.sdpMLineIndex]+="a="+event.candidate.candidate+"\r\n"}else{sections[event.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n"}pc._localDescription.sdp=SDPUtils.getDescription(pc._localDescription.sdp)+sections.join("");var complete=pc.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});if(pc.iceGatheringState!=="gathering"){pc.iceGatheringState="gathering";pc._emitGatheringStateChange()}if(!end){pc._dispatchEvent("icecandidate",event)}if(complete){pc._dispatchEvent("icecandidate",new Event("icecandidate"));pc.iceGatheringState="complete";pc._emitGatheringStateChange()}};window.setTimeout(function(){bufferedCandidateEvents.forEach(function(e){iceGatherer.onlocalcandidate(e)})},0)};RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var pc=this;var iceTransport=new window.RTCIceTransport(null);iceTransport.onicestatechange=function(){pc._updateIceConnectionState();pc._updateConnectionState()};var dtlsTransport=new window.RTCDtlsTransport(iceTransport);dtlsTransport.ondtlsstatechange=function(){pc._updateConnectionState()};dtlsTransport.onerror=function(){Object.defineProperty(dtlsTransport,"state",{value:"failed",writable:true});pc._updateConnectionState()};return{iceTransport:iceTransport,dtlsTransport:dtlsTransport}};RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer){delete iceGatherer.onlocalcandidate;delete this.transceivers[sdpMLineIndex].iceGatherer}var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;if(iceTransport){delete iceTransport.onicestatechange;delete this.transceivers[sdpMLineIndex].iceTransport}var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;if(dtlsTransport){delete dtlsTransport.ondtlsstatechange;delete dtlsTransport.onerror;delete this.transceivers[sdpMLineIndex].dtlsTransport}};RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);if(send&&transceiver.rtpSender){params.encodings=transceiver.sendEncodingParameters;params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound};if(transceiver.recvEncodingParameters.length){params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc}transceiver.rtpSender.send(params)}if(recv&&transceiver.rtpReceiver&&params.codecs.length>0){if(transceiver.kind==="video"&&transceiver.recvEncodingParameters&&edgeVersion<15019){transceiver.recvEncodingParameters.forEach(function(p){delete p.rtx})}if(transceiver.recvEncodingParameters.length){params.encodings=transceiver.recvEncodingParameters}else{params.encodings=[{}]}params.rtcp={compound:transceiver.rtcpParameters.compound};if(transceiver.rtcpParameters.cname){params.rtcp.cname=transceiver.rtcpParameters.cname}if(transceiver.sendEncodingParameters.length){params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc}transceiver.rtpReceiver.receive(params)}};RTCPeerConnection.prototype.setLocalDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setLocalDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set local "+description.type+" in state "+pc.signalingState))}var sections;var sessionpart;if(description.type==="offer"){sections=SDPUtils.splitSections(description.sdp);sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);pc.transceivers[sdpMLineIndex].localCapabilities=caps});pc.transceivers.forEach(function(transceiver,sdpMLineIndex){pc._gather(transceiver.mid,sdpMLineIndex)})}else if(description.type==="answer"){sections=SDPUtils.splitSections(pc._remoteDescription.sdp);sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=pc.transceivers[sdpMLineIndex];var iceGatherer=transceiver.iceGatherer;var iceTransport=transceiver.iceTransport;var dtlsTransport=transceiver.dtlsTransport;var localCapabilities=transceiver.localCapabilities;var remoteCapabilities=transceiver.remoteCapabilities;var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;if(!rejected&&!transceiver.rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);if(isIceLite){remoteDtlsParameters.role="server"}if(!pc.usingBundle||sdpMLineIndex===0){pc._gather(transceiver.mid,sdpMLineIndex);if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}var params=getCommonCapabilities(localCapabilities,remoteCapabilities);pc._transceive(transceiver,params.codecs.length>0,false)}})}pc._localDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-local-offer")}else{pc._updateSignalingState("stable")}return Promise.resolve()};RTCPeerConnection.prototype.setRemoteDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setRemoteDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set remote "+description.type+" in state "+pc.signalingState))}var streams={};pc.remoteStreams.forEach(function(stream){streams[stream.id]=stream});var receiverList=[];var sections=SDPUtils.splitSections(description.sdp);var sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;var usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;pc.usingBundle=usingBundle;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];if(iceOptions){pc.canTrickleIceCandidates=iceOptions.substr(14).split(" ").indexOf("trickle")>=0}else{pc.canTrickleIceCandidates=false}sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection);var kind=SDPUtils.getKind(mediaSection);var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;var protocol=lines[0].substr(2).split(" ")[2];var direction=SDPUtils.getDirection(mediaSection,sessionpart);var remoteMsid=SDPUtils.parseMsid(mediaSection);var mid=SDPUtils.getMid(mediaSection)||SDPUtils.generateIdentifier();if(rejected||kind==="application"&&(protocol==="DTLS/SCTP"||protocol==="UDP/DTLS/SCTP")){pc.transceivers[sdpMLineIndex]={mid:mid,kind:kind,protocol:protocol,rejected:true};return}if(!rejected&&pc.transceivers[sdpMLineIndex]&&pc.transceivers[sdpMLineIndex].rejected){pc.transceivers[sdpMLineIndex]=pc._createTransceiver(kind,true)}var transceiver;var iceGatherer;var iceTransport;var dtlsTransport;var rtpReceiver;var sendEncodingParameters;var recvEncodingParameters;var localCapabilities;var track;var remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);var remoteIceParameters;var remoteDtlsParameters;if(!rejected){remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);remoteDtlsParameters.role="client"}recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection);var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0;var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component===1});if((description.type==="offer"||description.type==="answer")&&!rejected&&usingBundle&&sdpMLineIndex>0&&pc.transceivers[sdpMLineIndex]){pc._disposeIceAndDtlsTransports(sdpMLineIndex);pc.transceivers[sdpMLineIndex].iceGatherer=pc.transceivers[0].iceGatherer;pc.transceivers[sdpMLineIndex].iceTransport=pc.transceivers[0].iceTransport;pc.transceivers[sdpMLineIndex].dtlsTransport=pc.transceivers[0].dtlsTransport;if(pc.transceivers[sdpMLineIndex].rtpSender){pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport)}if(pc.transceivers[sdpMLineIndex].rtpReceiver){pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport)}}if(description.type==="offer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex]||pc._createTransceiver(kind);transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,usingBundle)}if(cands.length&&transceiver.iceTransport.state==="new"){if(isComplete&&(!usingBundle||sdpMLineIndex===0)){transceiver.iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}localCapabilities=window.RTCRtpReceiver.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+2)*1001}];var isNewTrack=false;if(direction==="sendrecv"||direction==="sendonly"){isNewTrack=!transceiver.rtpReceiver;rtpReceiver=transceiver.rtpReceiver||new window.RTCRtpReceiver(transceiver.dtlsTransport,kind);if(isNewTrack){var stream;track=rtpReceiver.track;if(remoteMsid&&remoteMsid.stream==="-"){}else if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream;Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})}Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}});stream=streams[remoteMsid.stream]}else{if(!streams.default){streams.default=new window.MediaStream}stream=streams.default}if(stream){addTrackToStreamAndFireEvent(track,stream);transceiver.associatedRemoteMediaStreams.push(stream)}receiverList.push([track,rtpReceiver,stream])}}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track){transceiver.associatedRemoteMediaStreams.forEach(function(s){var nativeTrack=s.getTracks().find(function(t){return t.id===transceiver.rtpReceiver.track.id});if(nativeTrack){removeTrackFromStreamAndFireEvent(nativeTrack,s)}});transceiver.associatedRemoteMediaStreams=[]}transceiver.localCapabilities=localCapabilities;transceiver.remoteCapabilities=remoteCapabilities;transceiver.rtpReceiver=rtpReceiver;transceiver.rtcpParameters=rtcpParameters;transceiver.sendEncodingParameters=sendEncodingParameters;transceiver.recvEncodingParameters=recvEncodingParameters;pc._transceive(pc.transceivers[sdpMLineIndex],false,isNewTrack)}else if(description.type==="answer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex];iceGatherer=transceiver.iceGatherer;iceTransport=transceiver.iceTransport;dtlsTransport=transceiver.dtlsTransport;rtpReceiver=transceiver.rtpReceiver;sendEncodingParameters=transceiver.sendEncodingParameters;localCapabilities=transceiver.localCapabilities;pc.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters;pc.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities;pc.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters;if(cands.length&&iceTransport.state==="new"){if((isIceLite||isComplete)&&(!usingBundle||sdpMLineIndex===0)){iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}if(!usingBundle||sdpMLineIndex===0){if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,"controlling")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}pc._transceive(transceiver,direction==="sendrecv"||direction==="recvonly",direction==="sendrecv"||direction==="sendonly");if(rtpReceiver&&(direction==="sendrecv"||direction==="sendonly")){track=rtpReceiver.track;if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams[remoteMsid.stream]);receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])}else{if(!streams.default){streams.default=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams.default);receiverList.push([track,rtpReceiver,streams.default])}}else{delete transceiver.rtpReceiver}}});if(pc._dtlsRole===undefined){pc._dtlsRole=description.type==="offer"?"active":"passive"}pc._remoteDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-remote-offer")}else{pc._updateSignalingState("stable")}Object.keys(streams).forEach(function(sid){var stream=streams[sid];if(stream.getTracks().length){if(pc.remoteStreams.indexOf(stream)===-1){pc.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;window.setTimeout(function(){pc._dispatchEvent("addstream",event)})}receiverList.forEach(function(item){var track=item[0];var receiver=item[1];if(stream.id!==item[2].id){return}fireAddTrack(pc,track,receiver,[stream])})}});receiverList.forEach(function(item){if(item[2]){return}fireAddTrack(pc,item[0],item[1],[])});window.setTimeout(function(){if(!(pc&&pc.transceivers)){return}pc.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&transceiver.iceTransport.state==="new"&&transceiver.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");transceiver.iceTransport.addRemoteCandidate({})}})},4e3);return Promise.resolve()};RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport){transceiver.iceTransport.stop()}if(transceiver.dtlsTransport){transceiver.dtlsTransport.stop()}if(transceiver.rtpSender){transceiver.rtpSender.stop()}if(transceiver.rtpReceiver){transceiver.rtpReceiver.stop()}});this._isClosed=true;this._updateSignalingState("closed")};RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",event)};RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var pc=this;if(this.signalingState!=="stable"||this.needNegotiation===true){return}this.needNegotiation=true;window.setTimeout(function(){if(pc.needNegotiation){pc.needNegotiation=false;var event=new Event("negotiationneeded");pc._dispatchEvent("negotiationneeded",event)}},0)};RTCPeerConnection.prototype._updateIceConnectionState=function(){var newState;var states={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&!transceiver.rejected){states[transceiver.iceTransport.state]++}});newState="new";if(states.failed>0){newState="failed"}else if(states.checking>0){newState="checking"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}else if(states.completed>0){newState="completed"}if(newState!==this.iceConnectionState){this.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",event)}};RTCPeerConnection.prototype._updateConnectionState=function(){var newState;var states={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&transceiver.dtlsTransport&&!transceiver.rejected){states[transceiver.iceTransport.state]++;states[transceiver.dtlsTransport.state]++}});states.connected+=states.completed;newState="new";if(states.failed>0){newState="failed"}else if(states.connecting>0){newState="connecting"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}if(newState!==this.connectionState){this.connectionState=newState;var event=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",event)}};RTCPeerConnection.prototype.createOffer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"))}var numAudioTracks=pc.transceivers.filter(function(t){return t.kind==="audio"}).length;var numVideoTracks=pc.transceivers.filter(function(t){return t.kind==="video"}).length;var offerOptions=arguments[0];if(offerOptions){if(offerOptions.mandatory||offerOptions.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(offerOptions.offerToReceiveAudio!==undefined){if(offerOptions.offerToReceiveAudio===true){numAudioTracks=1}else if(offerOptions.offerToReceiveAudio===false){numAudioTracks=0}else{numAudioTracks=offerOptions.offerToReceiveAudio}}if(offerOptions.offerToReceiveVideo!==undefined){if(offerOptions.offerToReceiveVideo===true){numVideoTracks=1}else if(offerOptions.offerToReceiveVideo===false){numVideoTracks=0}else{numVideoTracks=offerOptions.offerToReceiveVideo}}}pc.transceivers.forEach(function(transceiver){if(transceiver.kind==="audio"){numAudioTracks--;if(numAudioTracks<0){transceiver.wantReceive=false}}else if(transceiver.kind==="video"){numVideoTracks--;if(numVideoTracks<0){transceiver.wantReceive=false}}});while(numAudioTracks>0||numVideoTracks>0){if(numAudioTracks>0){pc._createTransceiver("audio");numAudioTracks--}if(numVideoTracks>0){pc._createTransceiver("video");numVideoTracks--}}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.transceivers.forEach(function(transceiver,sdpMLineIndex){var track=transceiver.track;var kind=transceiver.kind;var mid=transceiver.mid||SDPUtils.generateIdentifier();transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,pc.usingBundle)}var localCapabilities=window.RTCRtpSender.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}localCapabilities.codecs.forEach(function(codec){if(codec.name==="H264"&&codec.parameters["level-asymmetry-allowed"]===undefined){codec.parameters["level-asymmetry-allowed"]="1"}if(transceiver.remoteCapabilities&&transceiver.remoteCapabilities.codecs){transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec){if(codec.name.toLowerCase()===remoteCodec.name.toLowerCase()&&codec.clockRate===remoteCodec.clockRate){codec.preferredPayloadType=remoteCodec.payloadType}})}});localCapabilities.headerExtensions.forEach(function(hdrExt){var remoteExtensions=transceiver.remoteCapabilities&&transceiver.remoteCapabilities.headerExtensions||[];remoteExtensions.forEach(function(rHdrExt){if(hdrExt.uri===rHdrExt.uri){hdrExt.id=rHdrExt.id}})});var sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+1)*1001}];if(track){if(edgeVersion>=15019&&kind==="video"&&!sendEncodingParameters[0].rtx){sendEncodingParameters[0].rtx={ssrc:sendEncodingParameters[0].ssrc+1}}}if(transceiver.wantReceive){transceiver.rtpReceiver=new window.RTCRtpReceiver(transceiver.dtlsTransport,kind)}transceiver.localCapabilities=localCapabilities;transceiver.sendEncodingParameters=sendEncodingParameters});if(pc._config.bundlePolicy!=="max-compat"){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";pc.transceivers.forEach(function(transceiver,sdpMLineIndex){sdp+=writeMediaSection(transceiver,transceiver.localCapabilities,"offer",transceiver.stream,pc._dtlsRole);sdp+="a=rtcp-rsize\r\n";if(transceiver.iceGatherer&&pc.iceGatheringState!=="new"&&(sdpMLineIndex===0||!pc.usingBundle)){transceiver.iceGatherer.getLocalCandidates().forEach(function(cand){cand.component=1;sdp+="a="+SDPUtils.writeCandidate(cand)+"\r\n"});if(transceiver.iceGatherer.state==="completed"){sdp+="a=end-of-candidates\r\n"}}});var desc=new window.RTCSessionDescription({type:"offer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.createAnswer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"))}if(!(pc.signalingState==="have-remote-offer"||pc.signalingState==="have-local-pranswer")){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+pc.signalingState))}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);if(pc.usingBundle){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";var mediaSectionsInOffer=SDPUtils.getMediaSections(pc._remoteDescription.sdp).length;pc.transceivers.forEach(function(transceiver,sdpMLineIndex){if(sdpMLineIndex+1>mediaSectionsInOffer){return}if(transceiver.rejected){if(transceiver.kind==="application"){if(transceiver.protocol==="DTLS/SCTP"){sdp+="m=application 0 DTLS/SCTP 5000\r\n"}else{sdp+="m=application 0 "+transceiver.protocol+" webrtc-datachannel\r\n"}}else if(transceiver.kind==="audio"){sdp+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\n"+"a=rtpmap:0 PCMU/8000\r\n"}else if(transceiver.kind==="video"){sdp+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\n"+"a=rtpmap:120 VP8/90000\r\n"}sdp+="c=IN IP4 0.0.0.0\r\n"+"a=inactive\r\n"+"a=mid:"+transceiver.mid+"\r\n";return}if(transceiver.stream){var localTrack;if(transceiver.kind==="audio"){localTrack=transceiver.stream.getAudioTracks()[0]}else if(transceiver.kind==="video"){localTrack=transceiver.stream.getVideoTracks()[0]}if(localTrack){if(edgeVersion>=15019&&transceiver.kind==="video"&&!transceiver.sendEncodingParameters[0].rtx){transceiver.sendEncodingParameters[0].rtx={ssrc:transceiver.sendEncodingParameters[0].ssrc+1}}}}var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}sdp+=writeMediaSection(transceiver,commonCapabilities,"answer",transceiver.stream,pc._dtlsRole);if(transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize){sdp+="a=rtcp-rsize\r\n"}});var desc=new window.RTCSessionDescription({type:"answer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.addIceCandidate=function(candidate){var pc=this;var sections;if(candidate&&!(candidate.sdpMLineIndex!==undefined||candidate.sdpMid)){return Promise.reject(new TypeError("sdpMLineIndex or sdpMid required"))}return new Promise(function(resolve,reject){if(!pc._remoteDescription){return reject(makeError("InvalidStateError","Can not add ICE candidate without a remote description"))}else if(!candidate||candidate.candidate===""){for(var j=0;j<pc.transceivers.length;j++){if(pc.transceivers[j].rejected){continue}pc.transceivers[j].iceTransport.addRemoteCandidate({});sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp);sections[j]+="a=end-of-candidates\r\n";pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("");if(pc.usingBundle){break}}}else{var sdpMLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid){for(var i=0;i<pc.transceivers.length;i++){if(pc.transceivers[i].mid===candidate.sdpMid){sdpMLineIndex=i;break}}}var transceiver=pc.transceivers[sdpMLineIndex];if(transceiver){if(transceiver.rejected){return resolve()}var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if(cand.protocol==="tcp"&&(cand.port===0||cand.port===9)){return resolve()}if(cand.component&&cand.component!==1){return resolve()}if(sdpMLineIndex===0||sdpMLineIndex>0&&transceiver.iceTransport!==pc.transceivers[0].iceTransport){if(!maybeAddCandidate(transceiver.iceTransport,cand)){return reject(makeError("OperationError","Can not add ICE candidate"))}}var candidateString=candidate.candidate.trim();if(candidateString.indexOf("a=")===0){candidateString=candidateString.substr(2)}sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp);sections[sdpMLineIndex]+="a="+(cand.type?candidateString:"end-of-candidates")+"\r\n";pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("")}else{return reject(makeError("OperationError","Can not add ICE candidate"))}}resolve()})};RTCPeerConnection.prototype.getStats=function(selector){if(selector&&selector instanceof window.MediaStreamTrack){var senderOrReceiver=null;this.transceivers.forEach(function(transceiver){if(transceiver.rtpSender&&transceiver.rtpSender.track===selector){senderOrReceiver=transceiver.rtpSender}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track===selector){senderOrReceiver=transceiver.rtpReceiver}});if(!senderOrReceiver){throw makeError("InvalidAccessError","Invalid selector.")}return senderOrReceiver.getStats()}var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){if(transceiver[method]){promises.push(transceiver[method].getStats())}})});return Promise.all(promises).then(function(allStats){var results=new Map;allStats.forEach(function(stats){stats.forEach(function(stat){results.set(stat.id,stat)})});return results})};var ortcObjects=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];ortcObjects.forEach(function(ortcObjectName){var obj=window[ortcObjectName];if(obj&&obj.prototype&&obj.prototype.getStats){var nativeGetstats=obj.prototype.getStats;obj.prototype.getStats=function(){return nativeGetstats.apply(this).then(function(nativeStats){var mapStats=new Map;Object.keys(nativeStats).forEach(function(id){nativeStats[id].type=fixStatsType(nativeStats[id]);mapStats.set(id,nativeStats[id])});return mapStats})}}});var methods=["createOffer","createAnswer"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[0]==="function"||typeof args[1]==="function"){return nativeMethod.apply(this,[arguments[2]]).then(function(description){if(typeof args[0]==="function"){args[0].apply(null,[description])}},function(error){if(typeof args[1]==="function"){args[1].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});methods=["setLocalDescription","setRemoteDescription","addIceCandidate"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"||typeof args[2]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}},function(error){if(typeof args[2]==="function"){args[2].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});["getStats"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}})}return nativeMethod.apply(this,arguments)}});return RTCPeerConnection}},{sdp:17}],17:[function(require,module,exports){var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};SDPUtils.localCName=SDPUtils.generateIdentifier();SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})};SDPUtils.splitSections=function(blob){var parts=blob.split("\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})};SDPUtils.getDescription=function(blob){var sections=SDPUtils.splitSections(blob);return sections&&sections[0]};SDPUtils.getMediaSections=function(blob){var sections=SDPUtils.splitSections(blob);sections.shift();return sections};SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return line.indexOf(prefix)===0})};SDPUtils.parseCandidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parseInt(parts[1],10),protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],address:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;case"ufrag":candidate.ufrag=parts[i+1];candidate.usernameFragment=parts[i+1];break;default:candidate[parts[i]]=parts[i+1];break}}return candidate};SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.address||candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type!=="host"&&candidate.relatedAddress&&candidate.relatedPort){sdp.push("raddr");sdp.push(candidate.relatedAddress);sdp.push("rport");sdp.push(candidate.relatedPort)}if(candidate.tcpType&&candidate.protocol.toLowerCase()==="tcp"){sdp.push("tcptype");sdp.push(candidate.tcpType)}if(candidate.usernameFragment||candidate.ufrag){sdp.push("ufrag");sdp.push(candidate.usernameFragment||candidate.ufrag)}return"candidate:"+sdp.join(" ")};SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")};SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" ");var parsed={payloadType:parseInt(parts.shift(),10)};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockRate=parseInt(parts[1],10);parsed.channels=parts.length===3?parseInt(parts[2],10):1;parsed.numChannels=parsed.channels;return parsed};SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}var channels=codec.channels||codec.numChannels||1;return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(channels!==1?"/"+channels:"")+"\r\n"};SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}};SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&headerExtension.direction!=="sendrecv"?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"};SDPUtils.parseFmtp=function(line){var parsed={};var kv;var parts=line.substr(line.indexOf(" ")+1).split(";");for(var j=0;j<parts.length;j++){kv=parts[j].trim().split("=");parsed[kv[0].trim()]=kv[1]}return parsed};SDPUtils.writeFmtp=function(codec){var line="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){if(codec.parameters[param]){params.push(param+"="+codec.parameters[param])}else{params.push(param)}});line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line};SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}};SDPUtils.writeRtcpFb=function(codec){var lines="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.rtcpFeedback&&codec.rtcpFeedback.length){codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})}return lines};SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" ");var parts={ssrc:parseInt(line.substr(7,sp-7),10)};var colon=line.indexOf(":",sp);if(colon>-1){parts.attribute=line.substr(sp+1,colon-sp-1);parts.value=line.substr(colon+1)}else{parts.attribute=line.substr(sp+1)}return parts};SDPUtils.parseSsrcGroup=function(line){var parts=line.substr(13).split(" ");return{semantics:parts.shift(),ssrcs:parts.map(function(ssrc){return parseInt(ssrc,10)})}};SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid){return mid.substr(6)}};SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}};SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:");return{role:"auto",fingerprints:lines.map(SDPUtils.parseFingerprint)}};SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"});return sdp};SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var iceParameters={usernameFragment:lines.filter(function(line){return line.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:lines.filter(function(line){return line.indexOf("a=ice-pwd:")===0})[0].substr(10)};return iceParameters};SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\n"+"a=ice-pwd:"+params.password+"\r\n"};SDPUtils.parseRtpParameters=function(mediaSection){var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");for(var i=3;i<mline.length;i++){var pt=mline[i];var rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline);var fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{};codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb);description.codecs.push(codec);switch(codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase());break;default:break}}}SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))});return description};SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ";sdp+=caps.codecs.length>0?"9":"0";sdp+=" UDP/TLS/RTP/SAVPF ";sdp+=caps.codecs.map(function(codec){if(codec.preferredPayloadType!==undefined){return codec.preferredPayloadType}return codec.payloadType}).join(" ")+"\r\n";sdp+="c=IN IP4 0.0.0.0\r\n";sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n";caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec);sdp+=SDPUtils.writeFmtp(codec);sdp+=SDPUtils.writeRtcpFb(codec)});var maxptime=0;caps.codecs.forEach(function(codec){if(codec.maxptime>maxptime){maxptime=codec.maxptime}});if(maxptime>0){sdp+="a=maxptime:"+maxptime+"\r\n"}sdp+="a=rtcp-mux\r\n";if(caps.headerExtensions){caps.headerExtensions.forEach(function(extension){sdp+=SDPUtils.writeExtmap(extension)})}return sdp};SDPUtils.parseRtpEncodingParameters=function(mediaSection){var encodingParameters=[];var description=SDPUtils.parseRtpParameters(mediaSection);var hasRed=description.fecMechanisms.indexOf("RED")!==-1;var hasUlpfec=description.fecMechanisms.indexOf("ULPFEC")!==-1;var ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="cname"});var primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc;var secondarySsrc;var flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.substr(17).split(" ");return parts.map(function(part){return parseInt(part,10)})});if(flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc){secondarySsrc=flows[0][1]}description.codecs.forEach(function(codec){if(codec.name.toUpperCase()==="RTX"&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10)};if(primarySsrc&&secondarySsrc){encParam.rtx={ssrc:secondarySsrc}}encodingParameters.push(encParam);if(hasRed){encParam=JSON.parse(JSON.stringify(encParam));encParam.fec={ssrc:primarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"};encodingParameters.push(encParam)}}});if(encodingParameters.length===0&&primarySsrc){encodingParameters.push({ssrc:primarySsrc})}var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");if(bandwidth.length){if(bandwidth[0].indexOf("b=TIAS:")===0){bandwidth=parseInt(bandwidth[0].substr(7),10)}else if(bandwidth[0].indexOf("b=AS:")===0){bandwidth=parseInt(bandwidth[0].substr(5),10)*1e3*.95-50*40*8}else{bandwidth=undefined}encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})}return encodingParameters};SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={};var remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return obj.attribute==="cname"})[0];if(remoteSsrc){rtcpParameters.cname=remoteSsrc.value;rtcpParameters.ssrc=remoteSsrc.ssrc}var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0;rtcpParameters.compound=rsize.length===0;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");rtcpParameters.mux=mux.length>0;return rtcpParameters};SDPUtils.parseMsid=function(mediaSection){var parts;var spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(spec.length===1){parts=spec[0].substr(7).split(" ");return{stream:parts[0],track:parts[1]}}var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(msidParts){return msidParts.attribute==="msid"});if(planB.length>0){parts=planB[0].value.split(" ");return{stream:parts[0],track:parts[1]}}};SDPUtils.parseSctpDescription=function(mediaSection){var mline=SDPUtils.parseMLine(mediaSection);var maxSizeLine=SDPUtils.matchPrefix(mediaSection,"a=max-message-size:");var maxMessageSize;if(maxSizeLine.length>0){maxMessageSize=parseInt(maxSizeLine[0].substr(19),10)}if(isNaN(maxMessageSize)){maxMessageSize=65536}var sctpPort=SDPUtils.matchPrefix(mediaSection,"a=sctp-port:");if(sctpPort.length>0){return{port:parseInt(sctpPort[0].substr(12),10),protocol:mline.fmt,maxMessageSize:maxMessageSize}}var sctpMapLines=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:");if(sctpMapLines.length>0){var parts=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(parts[0],10),protocol:parts[1],maxMessageSize:maxMessageSize}}};SDPUtils.writeSctpDescription=function(media,sctp){var output=[];if(media.protocol!=="DTLS/SCTP"){output=["m="+media.kind+" 9 "+media.protocol+" "+sctp.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+sctp.port+"\r\n"]}else{output=["m="+media.kind+" 9 "+media.protocol+" "+sctp.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+sctp.port+" "+sctp.protocol+" 65535\r\n"]}if(sctp.maxMessageSize!==undefined){output.push("a=max-message-size:"+sctp.maxMessageSize+"\r\n")}return output.join("")};SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)};SDPUtils.writeSessionBoilerplate=function(sessId,sessVer,sessUser){var sessionId;var version=sessVer!==undefined?sessVer:2;if(sessId){sessionId=sessId}else{sessionId=SDPUtils.generateSessionId()}var user=sessUser||"thisisadapterortc";return"v=0\r\n"+"o="+user+" "+sessionId+" "+version+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.direction){sdp+="a="+transceiver.direction+"\r\n"}else if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp};SDPUtils.getDirection=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);for(var i=0;i<lines.length;i++){switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2);default:}}if(sessionpart){return SDPUtils.getDirection(sessionpart)}return"sendrecv"};SDPUtils.getKind=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");return mline[0].substr(2)};SDPUtils.isRejected=function(mediaSection){return mediaSection.split(" ",2)[1]==="0"};SDPUtils.parseMLine=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var parts=lines[0].substr(2).split(" ");return{kind:parts[0],port:parseInt(parts[1],10),protocol:parts[2],fmt:parts.slice(3).join(" ")}};SDPUtils.parseOLine=function(mediaSection){var line=SDPUtils.matchPrefix(mediaSection,"o=")[0];var parts=line.substr(2).split(" ");return{username:parts[0],sessionId:parts[1],sessionVersion:parseInt(parts[2],10),netType:parts[3],addressType:parts[4],address:parts[5]}};SDPUtils.isValidSDP=function(blob){if(typeof blob!=="string"||blob.length===0){return false}var lines=SDPUtils.splitLines(blob);for(var i=0;i<lines.length;i++){if(lines[i].length<2||lines[i].charAt(1)!=="="){return false}}return true};if(typeof module==="object"){module.exports=SDPUtils}},{}]},{},[1])(1)});(function(root,factory){if(typeof define==="function"&&define.amd){define("easyrtc",["easyrtc_lang","webrtc-adapter","socket.io"],factory)}else if(typeof module==="object"&&module.exports){module.exports=factory(require("easyrtc_lang"),require("webrtc-adapter"),require("socket.io"))}else{if(typeof window.io==="undefined"||!window.io){throw new Error("easyrtc requires socket.io")}root.easyrtc=factory(window.easyrtc_lang,window.adapter,window.io)}})(this,function(easyrtc_lang,adapter,io,undefined){var Easyrtc=function(){var self=this;var peerConns={};var stillAliveTimer=null;var stillAlivePeriod=0;var missedAliveResponses=0;function stillAliveEmitter(){if(!stillAlivePeriod){return}if(stillAliveTimer){clearTimeout(stillAliveTimer)}if(missedAliveResponses===1){self.showError(self.errCodes.SYSTEM_ERR,"Timed out trying to talk to the server.");self.printpeerconns();self.hangupAll();self.disconnect();return}stillAliveTimer=setTimeout(stillAliveEmitter,20*1e3);missedAliveResponses++;sendSignalling(null,"stillAlive",{},function(msgType,msgData){missedAliveResponses=0},function(){})}function logDebug(message,obj){if(self.debugPrinter){self.debugPrinter(message,obj)}}function isEmptyObj(obj){if(obj===null||obj===undefined){return true}var key;for(key in obj){if(obj.hasOwnProperty(key)){return false}}return true}var autoInitUserMedia=true;var sdpLocalFilter=null;var sdpRemoteFilter=null;var iceCandidateFilter=null;var iceConnectionStateChangeListener=null;var signalingStateChangeListener=null;var connectionOptions={"connect timeout":1e4,"force new connection":true};function stopStream(stream){var i;var tracks;tracks=stream.getAudioTracks();for(i=0;i<tracks.length;i++){try{tracks[i].stop()}catch(err){}}tracks=stream.getVideoTracks();for(i=0;i<tracks.length;i++){try{tracks[i].stop()}catch(err){}}if(typeof stream.stop==="function"){try{stream.stop()}catch(err){}}}this.setSdpFilters=function(localFilter,remoteFilter){sdpLocalFilter=localFilter;sdpRemoteFilter=remoteFilter};this.setPeerClosedListener=function(handler){this.onPeerClosed=handler};this.setPeerOpenListener=function(handler){this.onPeerOpen=handler};this.setPeerFailingListener=function(failingHandler,recoveredHandler){this.onPeerFailing=failingHandler;this.onPeerRecovered=recoveredHandler};this.setIceCandidateFilter=function(filter){iceCandidateFilter=filter};this.setIceConnectionStateChangeListener=function(listener){iceConnectionStateChangeListener=listener};this.setSignalingStateChangeListener=function(listener){signalingStateChangeListener=listener};this.setAutoInitUserMedia=function(flag){autoInitUserMedia=!!flag};this.format=function(format,arg1,arg2,arg3){var formatted=arguments[0];for(var i=1;i<arguments.length;i++){var regexp=new RegExp("\\{"+(i-1)+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted};function addStreamToPeerConnection(stream,peerConnection){if(peerConnection.addStream){var existingStreams=peerConnection.getLocalStreams();if(existingStreams.indexOf(stream)===-1){peerConnection.addStream(stream)}}else{var existingTracks=peerConnection.getSenders();var tracks=stream.getAudioTracks();var i;for(i=0;i<tracks.length;i++){if(existingTracks.indexOf(tracks[i])===-1){peerConnection.addTrack(tracks[i])}}tracks=stream.getVideoTracks();for(i=0;i<tracks.length;i++){if(existingTracks.indexOf(tracks[i])===-1){peerConnection.addTrack(tracks[i])}}}}this.renegotiate=function(otherUser){var peerConnObj=peerConns[otherUser];if(!peerConnObj){logDebug("Attempt to renegotiate ice on nonexistant connection");return}var callFailureCB=peerConnObj.callFailureCB||self.showError;var pc=peerConnObj.pc;var setLocalAndSendMessage0=function(sessionDescription){if(peerConnObj.cancelled){logDebug("renegotiate.setLocalAndSendMessage0.ignored",peerConnObj.cancelled,peerConnObj.sendingOffer);return}var sendOffer=function(){peerConnObj.sendingOffer=false;sendSignalling(otherUser,"offer",sessionDescription,null,callFailureCB)};if(sdpLocalFilter){sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)}pc.setLocalDescription(sessionDescription).then(sendOffer,function(errorText){peerConnObj.sendingOffer=false;callFailureCB(self.errCodes.CALL_ERR,errorText)})};if(peerConnObj.sendingOffer){logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.sendingOffer);return}peerConnObj.sendingOffer=true;pc.createOffer({iceRestart:true}).then(setLocalAndSendMessage0).catch(function(reason){peerConnObj.sendingOffer=false;callFailureCB(self.errCodes.CALL_ERR,JSON.stringify(reason))})};function isSocketConnected(socket){return socket&&(socket.socket&&socket.socket.connected||socket.connected)}var haveAudioVideo={audio:false,video:false};this.getConstantString=function(key){if(easyrtc_lang[key]){return easyrtc_lang[key]}else{self.showError(self.errCodes.DEVELOPER_ERR,"Could not find key='"+key+"' in easyrtc_lang");return key}};var allowedEvents={roomOccupant:true,roomOccupants:true};var eventListeners={};function event(eventName,callingFunction){if(typeof eventName!=="string"){self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called without a string as the first argument");throw"developer error"}if(!allowedEvents[eventName]){self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called with a bad event name = "+eventName);throw"developer error"}}this.addEventListener=function(eventName,eventListener){event(eventName,"addEventListener");if(typeof eventListener!=="function"){self.showError(self.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument");throw"developer error"}self.removeEventListener(eventName,eventListener);if(!eventListeners[eventName]){eventListeners[eventName]=[]}eventListeners[eventName][eventListeners[eventName].length]=eventListener};this.removeEventListener=function(eventName,eventListener){event(eventName,"removeEventListener");var listeners=eventListeners[eventName];var i=0;if(listeners){for(i=0;i<listeners.length;i++){if(listeners[i]===eventListener){if(i<listeners.length-1){listeners[i]=listeners[listeners.length-1]}listeners.length=listeners.length-1}}}};this.emitEvent=function(eventName,eventData){event(eventName,"emitEvent");var listeners=eventListeners[eventName];var i=0;if(listeners){for(i=0;i<listeners.length;i++){listeners[i](eventName,eventData)}}};this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL",ICECANDIDATE_ERR:"ICECANDIDATE_ERR",NOVIABLEICE:"NOVIABLEICE",SIGNAL_ERR:"SIGNAL_ERR"};this.apiVersion="1.1.1-beta";this.ackMessage={msgType:"ack"};this.usernameRegExp=/^(.){1,64}$/;this.cookieId="easyrtcsid";this.username=null;this.loggingOut=false;this.disconnecting=false;var namedLocalMediaStreams={};var sessionFields=[];var receivedMediaConstraints={};this.enableAudioReceive=function(value){if(adapter&&adapter.browserDetails&&(adapter.browserDetails.browser==="chrome"&&adapter.browserDetails.version<65)){receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{};receivedMediaConstraints.mandatory.OfferToReceiveAudio=value}else{receivedMediaConstraints.offerToReceiveAudio=value}};this.enableVideoReceive=function(value){if(adapter&&adapter.browserDetails&&(adapter.browserDetails.browser==="chrome"&&adapter.browserDetails.version<65)){receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{};receivedMediaConstraints.mandatory.OfferToReceiveVideo=value}else{receivedMediaConstraints.offerToReceiveVideo=value}};this.enableAudioReceive(true);this.enableVideoReceive(true);function getSourceList(callback,sourceType){navigator.mediaDevices.enumerateDevices().then(function(values){var results=[];for(var i=0;i<values.length;i++){var source=values[i];if(source.kind===sourceType){if(!source.id){source.id=source.deviceId}results.push(source)}}callback(results)}).catch(function(reason){logDebug("Unable to enumerate devices ("+reason+")")})}this.setAudioOutput=function(element,sinkId){if(typeof element.sinkId!=="undefined"){element.setSinkId(sinkId).then(function(){logDebug("Success, audio output device attached: "+sinkId+" to "+"element with "+element.title+" as source.")}).catch(function(error){var errorMessage=error;if(error.name==="SecurityError"){errorMessage="You need to use HTTPS for selecting audio output "+"device: "+error}logDebug(errorMessage)})}else{logDebug("Browser does not support output device selection.")}};this.getAudioSinkList=function(callback){getSourceList(callback,"audiooutput")};this.getAudioSourceList=function(callback){getSourceList(callback,"audioinput")};this.getVideoSourceList=function(callback){getSourceList(callback,"videoinput")};var dataChannelName="dc";var oldConfig={};var offersPending={};var credential=null;self.audioEnabled=true;self.videoEnabled=true;this.debugPrinter=null;this.myEasyrtcid="";this.nativeVideoHeight=0;this.maxP2PMessageLength=1e3;this.nativeVideoWidth=0;this.roomJoin={};this.isNameValid=function(name){return self.usernameRegExp.test(name)};this.setCookieId=function(cookieId){self.cookieId=cookieId};this._desiredVideoProperties={};this.setVideoSource=function(videoSrcId){self._desiredVideoProperties.videoSrcId=videoSrcId};this.setScreenCapture=function(enableScreenCapture,mediaSourceId){if(enableScreenCapture){self._presetMediaConstraints={video:{mozMediaSource:"screen",chromeMediaSource:"screen",mediaSource:"screen",mediaSourceId:"screen:0",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:15},audio:false};if(mediaSourceId){if(adapter&&adapter.browserDetails&&adapter.browserDetails.browser==="chrome"){var mandatory=self._presetMediaConstraints.video;mandatory.chromeMediaSource="desktop";mandatory.chromeMediaSourceId=mediaSourceId;self._presetMediaConstraints.video={mandatory:mandatory,optional:[{googTemporalLayeredScreencast:true}]}}else{self._presetMediaConstraints.video.mediaSourceId=mediaSourceId}}}else{delete self._presetMediaConstraints}};this._desiredAudioProperties={};this.setAudioSource=function(audioSrcId){self._desiredAudioProperties.audioSrcId=audioSrcId};this.setVideoDims=function(width,height,frameRate){self._desiredVideoProperties.width=width;self._desiredVideoProperties.height=height;if(frameRate!==undefined){self._desiredVideoProperties.frameRate=frameRate}};self.getUserMediaConstraints=function(){var constraints={};if(self._presetMediaConstraints){constraints=self._presetMediaConstraints;delete self._presetMediaConstraints;return constraints}else if(!self.videoEnabled){constraints.video=false}else{if(adapter&&adapter.browserDetails&&(adapter.browserDetails.browser==="firefox"||adapter.browserDetails.browser==="edge")){constraints.video={};if(self._desiredVideoProperties.width){constraints.video.width=self._desiredVideoProperties.width}if(self._desiredVideoProperties.height){constraints.video.height=self._desiredVideoProperties.height}if(self._desiredVideoProperties.frameRate){constraints.video.frameRate={minFrameRate:self._desiredVideoProperties.frameRate,maxFrameRate:self._desiredVideoProperties.frameRate}}if(self._desiredVideoProperties.videoSrcId){constraints.video.deviceId=self._desiredVideoProperties.videoSrcId}}else{constraints.video={};if(self._desiredVideoProperties.width){constraints.video.width={max:self._desiredVideoProperties.width,min:self._desiredVideoProperties.width,ideal:self._desiredVideoProperties.width}}if(self._desiredVideoProperties.height){constraints.video.height={max:self._desiredVideoProperties.height,min:self._desiredVideoProperties.height,ideal:self._desiredVideoProperties.height}}if(self._desiredVideoProperties.frameRate){constraints.video.frameRate={max:self._desiredVideoProperties.frameRate,ideal:self._desiredVideoProperties.frameRate}}if(self._desiredVideoProperties.videoSrcId){constraints.video.deviceId=self._desiredVideoProperties.videoSrcId}if(Object.keys(constraints.video).length===0){constraints.video=true}}}if(!self.audioEnabled){constraints.audio=false}else{constraints.audio={};if(self._desiredAudioProperties.audioSrcId){constraints.audio.deviceId=self._desiredAudioProperties.audioSrcId}}return constraints};this.setApplicationName=function(name){self.applicationName=name};this.enableDebug=function(enable){if(enable){self.debugPrinter=function(message,obj){var now=(new Date).toISOString();var stackString=(new Error).stack;var srcLine="location unknown";if(stackString){var stackFrameStrings=stackString.split("\n");srcLine="";if(stackFrameStrings.length>=5){srcLine=stackFrameStrings[4]}}console.log("debug "+now+" : "+message+" ["+srcLine+"]");if(typeof obj!=="undefined"){console.log("debug "+now+" : ",obj)}}}else{self.debugPrinter=null}};this.supportsGetUserMedia=function(){return navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia!=="undefined"};this.supportsPeerConnections=function(){return typeof RTCPeerConnection!=="undefined"};this.supportsDataChannels=function(){var hasCreateDataChannel=false;if(self.supportsPeerConnections()){try{var peer=new RTCPeerConnection({iceServers:[]},{});hasCreateDataChannel=typeof peer.createDataChannel!=="undefined";peer.close()}catch(err){}}return hasCreateDataChannel};this.supportsStatistics=function(){var hasGetStats=false;if(self.supportsPeerConnections()){try{var peer=new RTCPeerConnection({iceServers:[]},{});hasGetStats=typeof peer.getStats!=="undefined";peer.close()}catch(err){}}return hasGetStats};this.createRTCPeerConnection=function(pc_config,optionalStuff){if(self.supportsPeerConnections()){return new RTCPeerConnection(pc_config,optionalStuff)}else{throw"Your browser doesn't support webRTC (RTCPeerConnection)"}};this.getDatachannelConstraints=function(){return{reliable:adapter&&adapter.browserDetails&&adapter.browserDetails.browser!=="chrome"&&adapter.browserDetails.version<31}};haveAudioVideo={audio:false,video:false};var dataEnabled=false;var serverPath=null;var roomOccupantListener=null;var onDataChannelOpen=null;var onDataChannelClose=null;var lastLoggedInList={};var receivePeer={msgTypes:{}};var receiveServerCB=null;var updateConfigurationInfo=function(){};this.printpeerconns=function(){console.log("peerconns = ",peerConns)};var acceptancePending={};this.acceptCheck=function(caller,helper){helper(true)};this.streamAcceptor=function(easyrtcid,stream){};this.onStreamClosed=function(easyrtcid){};this.callCancelled=function(easyrtcid){};this.getPeerConnectionByUserId=function(userId){if(peerConns&&peerConns[userId]){return peerConns[userId].pc}return null};var chromeStatsFilter=[{googTransmitBitrate:"transmitBitRate",googActualEncBitrate:"encodeRate",googAvailableSendBandwidth:"availableSendRate"},{googCodecName:"audioCodec",googTypingNoiseState:"typingNoise",packetsSent:"audioPacketsSent",bytesSent:"audioBytesSent"},{googCodecName:"videoCodec",googFrameRateSent:"outFrameRate",packetsSent:"videoPacketsSent",bytesSent:"videoBytesSent"},{packetsLost:"videoPacketsLost",packetsReceived:"videoPacketsReceived",bytesReceived:"videoBytesReceived",googFrameRateOutput:"frameRateOut"},{packetsLost:"audioPacketsLost",packetsReceived:"audioPacketsReceived",bytesReceived:"audioBytesReceived",audioOutputLevel:"audioOutputLevel"},{googRemoteAddress:"remoteAddress",googActiveConnection:"activeConnection"},{audioInputLevel:"audioInputLevel"}];var firefoxStatsFilter={"outboundrtp_audio.bytesSent":"audioBytesSent","outboundrtp_video.bytesSent":"videoBytesSent","inboundrtp_video.bytesReceived":"videoBytesReceived","inboundrtp_audio.bytesReceived":"audioBytesReceived","outboundrtp_audio.packetsSent":"audioPacketsSent","outboundrtp_video.packetsSent":"videoPacketsSent","inboundrtp_video.packetsReceived":"videoPacketsReceived","inboundrtp_audio.packetsReceived":"audioPacketsReceived","inboundrtp_video.packetsLost":"videoPacketsLost","inboundrtp_audio.packetsLost":"audioPacketsLost",firefoxRemoteAddress:"remoteAddress"};this.standardStatsFilter=adapter&&adapter.browserDetails&&adapter.browserDetails.browser==="firefox"?firefoxStatsFilter:chromeStatsFilter;function getFirefoxPeerStatistics(peerId,callback,filter){if(!peerConns[peerId]){callback(peerId,{connected:false})}else if(peerConns[peerId].pc.getStats){peerConns[peerId].pc.getStats(null).then(function(stats){var items={};var candidates={};var activeId=null;var srcKey;if(stats){stats.forEach(function(entry){var majorKey;var subKey;if(entry.type.match(/boundrtp/)){if(entry.id.match(/audio/)){majorKey=entry.type+"_audio"}else if(entry.id.match(/video/)){majorKey=entry.type+"_video"}else{return}for(subKey in entry){if(entry.hasOwnProperty(subKey)){items[majorKey+"."+subKey]=entry[subKey]}}}else{if(entry.hasOwnProperty("ipAddress")&&entry.id){candidates[entry.id]=entry.ipAddress+":"+entry.portNumber}else if(entry.hasOwnProperty("selected")&&entry.hasOwnProperty("remoteCandidateId")&&entry.selected){activeId=entry.remoteCandidateId}}})}if(activeId){items.firefoxRemoteAddress=candidates[activeId]}if(!filter){callback(peerId,items)}else{var filteredItems={};for(srcKey in filter){if(filter.hasOwnProperty(srcKey)&&items.hasOwnProperty(srcKey)){filteredItems[filter[srcKey]]=items[srcKey]}}callback(peerId,filteredItems)}},function(error){logDebug("unable to get statistics")})}else{callback(peerId,{statistics:self.getConstantString("statsNotSupported")})}}function getChromePeerStatistics(peerId,callback,filter){if(!peerConns[peerId]){callback(peerId,{connected:false})}else if(peerConns[peerId].pc.getStats){peerConns[peerId].pc.getStats().then(function(stats){var localStats={};var part,parts=stats.result();var i,j;var itemKeys;var itemKey;var names;var userKey;var partNames=[];var partList;var bestBytes=0;var bestI;var turnAddress=null;var hasActive,curReceived;var localAddress,remoteAddress;if(!filter){for(i=0;i<parts.length;i++){names=parts[i].names();for(j=0;j<names.length;j++){itemKey=names[j];localStats[parts[i].id+"."+itemKey]=parts[i].stat(itemKey)}}}else{for(i=0;i<parts.length;i++){partNames[i]={};names=parts[i].names();for(j=0;j<names.length;j++){partNames[i][names[j]]=true}if(partNames[i].googRemoteAddress&&partNames[i].googActiveConnection){hasActive=parts[i].stat("googActiveConnection");if(hasActive===true||hasActive==="true"){curReceived=parseInt(parts[i].stat("bytesReceived"))+parseInt(parts[i].stat("bytesSent"));if(curReceived>bestBytes){bestI=i;bestBytes=curReceived}}}}for(i=0;i<parts.length;i++){if(partNames[i].googActiveConnection){if(i!==bestI){partNames[i]={}}else{localAddress=parts[i].stat("googLocalAddress").split(":")[0];remoteAddress=parts[i].stat("googRemoteAddress").split(":")[0];if(self.isTurnServer(localAddress)){turnAddress=localAddress}else if(self.isTurnServer(remoteAddress)){turnAddress=remoteAddress}}}}for(i=0;i<filter.length;i++){itemKeys=filter[i];partList=[];part=null;for(j=0;j<parts.length;j++){var fullMatch=true;for(itemKey in itemKeys){if(itemKeys.hasOwnProperty(itemKey)&&!partNames[j][itemKey]){fullMatch=false;break}}if(fullMatch&&parts[j]){partList.push(parts[j])}}if(partList.length===1){for(j=0;j<partList.length;j++){part=partList[j];if(part){for(itemKey in itemKeys){if(itemKeys.hasOwnProperty(itemKey)){userKey=itemKeys[itemKey];localStats[userKey]=part.stat(itemKey)}}}}}else if(partList.length>1){for(itemKey in itemKeys){if(itemKeys.hasOwnProperty(itemKey)){localStats[itemKeys[itemKey]]=[]}}for(j=0;j<partList.length;j++){part=partList[j];for(itemKey in itemKeys){if(itemKeys.hasOwnProperty(itemKey)){userKey=itemKeys[itemKey];localStats[userKey].push(part.stat(itemKey))}}}}}}if(localStats.remoteAddress&&turnAddress){localStats.remoteAddress=turnAddress}callback(peerId,localStats)})}else{callback(peerId,{statistics:self.getConstantString("statsNotSupported")})}}this.getPeerStatistics=function(easyrtcid,callback,filter){if(adapter&&adapter.browserDetails&&adapter.browserDetails.browser==="firefox"){getFirefoxPeerStatistics(easyrtcid,callback,filter)}else{getChromePeerStatistics(easyrtcid,callback,filter)}};function sendRoomApiFields(roomName,fields){var fieldAsString=JSON.stringify(fields);JSON.parse(fieldAsString);var dataToShip={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:roomName,field:fields}}};self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){if(ackMsg.msgType==="error"){self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)}})}self._roomApiFieldTimer={};function enqueueSendRoomApi(roomName){if(self._roomApiFieldTimer[roomName]){clearTimeout(self._roomApiFieldTimer[roomName])}self._roomApiFieldTimer[roomName]=setTimeout(function(){var roomApiFields=self._roomApiFields[roomName];if(roomApiFields){sendRoomApiFields(roomName,roomApiFields)}self._roomApiFieldTimer[roomName]=null},10)}this.setRoomApiField=function(roomName,fieldName,fieldValue){if(!self._roomApiFields){self._roomApiFields={}}if(!fieldName&&!fieldValue){clearTimeout(self._roomApiFieldTimer[roomName]);delete self._roomApiFields[roomName]}else{if(!self._roomApiFields[roomName]){self._roomApiFields[roomName]={}}if(fieldValue!==undefined&&fieldValue!==null){if(typeof fieldValue==="object"){try{JSON.stringify(fieldValue)}catch(jsonError){self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ");return}}self._roomApiFields[roomName][fieldName]={fieldName:fieldName,fieldValue:fieldValue}}else{delete self._roomApiFields[roomName][fieldName]}if(self.webSocketConnected){enqueueSendRoomApi(roomName)}}};this.showError=function(messageCode,message){self.onError({errorCode:messageCode,errorText:message})};var customErrorListener;this.setErrorListener=function(handler){customErrorListener=handler};this.onError=function(errorObject){logDebug("saw error "+errorObject.errorText);if(customErrorListener){logDebug("Using custom error handler");customErrorListener(errorObject);return}var errorDiv=document.getElementById("easyrtcErrorDialog");var errorBody;if(!errorDiv){errorDiv=document.createElement("div");errorDiv.id="easyrtcErrorDialog";var title=document.createElement("div");title.innerHTML="Error messages";title.className="easyrtcErrorDialog_title";errorDiv.appendChild(title);errorBody=document.createElement("div");errorBody.id="easyrtcErrorDialog_body";errorDiv.appendChild(errorBody);var clearButton=document.createElement("button");clearButton.appendChild(document.createTextNode("Okay"));clearButton.className="easyrtcErrorDialog_okayButton";clearButton.onclick=function(){errorBody.innerHTML="";errorDiv.style.display="none"};errorDiv.appendChild(clearButton);document.body.appendChild(errorDiv)}errorBody=document.getElementById("easyrtcErrorDialog_body");var messageNode=document.createElement("div");messageNode.className="easyrtcErrorDialog_element";messageNode.appendChild(document.createTextNode(errorObject.errorText));errorBody.appendChild(messageNode);errorDiv.style.display="block"};this.createObjectURL=function(mediaStream){var errMessage;if(window.URL&&window.URL.createObjectURL){return window.URL.createObjectURL(mediaStream)}else if(window.webkitURL&&window.webkitURL.createObjectURL){return window.webkit.createObjectURL(mediaStream)}else{errMessage="Your browsers does not support URL.createObjectURL.";logDebug("saw exception "+errMessage);throw errMessage}};this.cleanId=function(idString){var MAP={"&":"&amp;","<":"&lt;",">":"&gt;"};if(!idString){return""}return idString.replace(/[&<>]/g,function(c){return MAP[c]})};self.setRoomEntryListener=function(handler){self.roomEntryListener=handler};self.setRoomOccupantListener=function(listener){roomOccupantListener=listener};this.setDataChannelOpenListener=function(listener){onDataChannelOpen=listener};this.setDataChannelCloseListener=function(listener){onDataChannelClose=listener};this.getConnectionCount=function(){var count=0;var i;for(i in peerConns){if(peerConns.hasOwnProperty(i)){if(self.getConnectStatus(i)===self.IS_CONNECTED){count++}}}return count};this.setMaxP2PMessageLength=function(maxLength){this.maxP2PMessageLength=maxLength};this.enableAudio=function(enabled){self.audioEnabled=enabled};this.enableVideo=function(enabled){self.videoEnabled=enabled};this.enableDataChannels=function(enabled){dataEnabled=enabled};function enableMediaTracks(enable,tracks){var i;if(tracks){for(i=0;i<tracks.length;i++){var track=tracks[i];track.enabled=enable}}}function getLocalMediaStreamByName(streamName){if(!streamName){streamName="default"}if(namedLocalMediaStreams.hasOwnProperty(streamName)){return namedLocalMediaStreams[streamName]}else{return null}}this.getLocalMediaIds=function(){return Object.keys(namedLocalMediaStreams)};function buildMediaIds(){var mediaMap={};var streamName;for(streamName in namedLocalMediaStreams){if(namedLocalMediaStreams.hasOwnProperty(streamName)){mediaMap[streamName]=namedLocalMediaStreams[streamName].id||"default"}}return mediaMap}function registerLocalMediaStreamByName(stream,streamName){var roomName;if(!streamName){streamName="default"}stream.streamName=streamName;namedLocalMediaStreams[streamName]=stream;if(streamName!=="default"){var mediaIds=buildMediaIds(),roomData=self.roomData;for(roomName in roomData){if(roomData.hasOwnProperty(roomName)){self.setRoomApiField(roomName,"mediaIds",mediaIds)}}}}this.register3rdPartyLocalMediaStream=function(stream,streamName){return registerLocalMediaStreamByName(stream,streamName)};function getNameOfRemoteStream(easyrtcId,webrtcStreamId){var roomName;var mediaIds;var streamName;if(!webrtcStreamId){webrtcStreamId="default"}if(peerConns[easyrtcId]){streamName=peerConns[easyrtcId].remoteStreamIdToName[webrtcStreamId];if(streamName){return streamName}}for(roomName in self.roomData){if(self.roomData.hasOwnProperty(roomName)){mediaIds=self.getRoomApiField(roomName,easyrtcId,"mediaIds");if(!mediaIds){continue}for(streamName in mediaIds){if(mediaIds.hasOwnProperty(streamName)&&(mediaIds[streamName]===webrtcStreamId||webrtcStreamId.indexOf(mediaIds[streamName])===0||mediaIds[streamName].indexOf(webrtcStreamId)===0)){return streamName}}if(adapter&&adapter.browserDetails&&adapter.browserDetails.browser==="firefox"){if(mediaIds["default"]){return"default"}for(var anyName in mediaIds){if(mediaIds.hasOwnProperty(anyName)){return anyName}}}}}return undefined}this.getNameOfRemoteStream=function(easyrtcId,webrtcStream){if(typeof webrtcStream==="string"){return getNameOfRemoteStream(easyrtcId,webrtcStream)}else if(webrtcStream.id){return getNameOfRemoteStream(easyrtcId,webrtcStream.id)}};function closeLocalMediaStreamByName(streamName){if(!streamName){streamName="default"}var stream=self.getLocalStream(streamName);if(!stream){return}var streamId=stream.id||"default";var id;var roomName;if(namedLocalMediaStreams[streamName]){for(id in peerConns){if(peerConns.hasOwnProperty(id)){try{peerConns[id].pc.removeStream(stream)}catch(err){}self.sendPeerMessage(id,"__closingMediaStream",{streamId:streamId,streamName:streamName})}}stopStream(namedLocalMediaStreams[streamName]);delete namedLocalMediaStreams[streamName];if(streamName!=="default"){var mediaIds=buildMediaIds();for(roomName in self.roomData){if(self.roomData.hasOwnProperty(roomName)){self.setRoomApiField(roomName,"mediaIds",mediaIds)}}}}}this.closeLocalMediaStream=function(streamName){return closeLocalMediaStreamByName(streamName)};this.closeLocalStream=this.closeLocalMediaStream;this.enableCamera=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);if(stream&&stream.getVideoTracks){enableMediaTracks(enable,stream.getVideoTracks())}};this.enableMicrophone=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);if(stream&&stream.getAudioTracks){enableMediaTracks(enable,stream.getAudioTracks())}};this.muteVideoObject=function(videoObjectName,mute){var videoObject;if(typeof videoObjectName==="string"){videoObject=document.getElementById(videoObjectName);if(!videoObject){throw"Unknown video object "+videoObjectName}}else if(!videoObjectName){throw"muteVideoObject passed a null"}else{videoObject=videoObjectName}videoObject.muted=!!mute};self.getLocalStreamAsUrl=function(streamName){var stream=getLocalMediaStreamByName(streamName);if(stream===null){throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully"}return self.createObjectURL(stream)};this.getLocalStream=function(streamName){return getLocalMediaStreamByName(streamName)||null};this.clearMediaStream=function(element){if(element&&element.pause){element.pause()}if(typeof element.srcObject!=="undefined"){element.srcObject=null}else if(typeof element.mozSrcObject!=="undefined"){element.mozSrcObject=null}else if(typeof element.src!=="undefined"){element.src=""}};this.setVideoObjectSrc=function(element,stream){if(stream&&stream!==""){element.autoplay=true;if(typeof element.srcObject!=="undefined"){element.srcObject=stream}else if(typeof element.mozSrcObject!=="undefined"){element.mozSrcObject=self.createObjectURL(stream)}else if(typeof element.src!=="undefined"){element.src=self.createObjectURL(stream)}}else{self.clearMediaStream(element)}};this.buildLocalMediaStream=function(streamName,audioTracks,videoTracks){var i;if(typeof streamName!=="string"){self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name");return null}var streamToClone=null;for(var key in namedLocalMediaStreams){if(namedLocalMediaStreams.hasOwnProperty(key)){streamToClone=namedLocalMediaStreams[key];if(streamToClone){break}}}if(!streamToClone){for(key in peerConns){if(peerConns.hasOwnProperty(key)){var remoteStreams=peerConns[key].pc.getRemoteStreams();if(remoteStreams&&remoteStreams.length>0){streamToClone=remoteStreams[0]}}}}if(!streamToClone){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to create a mediastream without one to clone from");return null}var mediaClone=streamToClone.clone();var oldTracks=mediaClone.getTracks();if(audioTracks){for(i=0;i<audioTracks.length;i++){mediaClone.addTrack(audioTracks[i].clone())}}if(videoTracks){for(i=0;i<videoTracks.length;i++){mediaClone.addTrack(videoTracks[i].clone())}}for(i=0;i<oldTracks.length;i++){mediaClone.removeTrack(oldTracks[i])}registerLocalMediaStreamByName(mediaClone,streamName);return mediaClone};this.loadStylesheet=function(){var links=document.getElementsByTagName("link");var cssIndex,css;for(cssIndex in links){if(links.hasOwnProperty(cssIndex)){css=links[cssIndex];if(css.href&&css.href.match(/\/easyrtc.css/)){return}}}var easySheet=document.createElement("link");easySheet.setAttribute("rel","stylesheet");easySheet.setAttribute("type","text/css");easySheet.setAttribute("href","/easyrtc/easyrtc.css");var headSection=document.getElementsByTagName("head")[0];var firstHead=headSection.childNodes[0];headSection.insertBefore(easySheet,firstHead)};this.formatError=function(x){var name,result;if(x===null||typeof x==="undefined"){return"null"}if(typeof x==="string"){return x}else if(x.type&&x.description){return x.type+" : "+x.description}else if(typeof x==="object"){try{return JSON.stringify(x)}catch(oops){result="{";for(name in x){if(x.hasOwnProperty(name)){if(typeof x[name]==="string"){result=result+name+"='"+x[name]+"' "}}}result=result+"}";return result}}else{return"Strange case"}};this.initMediaSource=function(successCallback,errorCallback,streamName){logDebug("about to request local media");if(!streamName){streamName="default"}haveAudioVideo={audio:self.audioEnabled,video:self.videoEnabled};if(!errorCallback){errorCallback=function(errorCode,errorText){var message="easyrtc.initMediaSource: "+self.formatError(errorText);logDebug(message);self.showError(self.errCodes.MEDIA_ERR,message)}}if(!self.supportsGetUserMedia()){errorCallback(self.errCodes.MEDIA_ERR,self.getConstantString("noWebrtcSupport"));return}if(!successCallback){self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");return}var mode=self.getUserMediaConstraints();var onUserMediaSuccess=function(stream){logDebug("getUserMedia success callback entered");logDebug("successfully got local media");stream.streamName=streamName;registerLocalMediaStreamByName(stream,streamName);var videoObj,triesLeft,tryToGetSize;if(haveAudioVideo.video){videoObj=document.createElement("video");videoObj.style.display="none";document.body.appendChild(videoObj);videoObj.muted=true;triesLeft=30;tryToGetSize=function(){if(videoObj.videoWidth>0||triesLeft<0){self.nativeVideoWidth=videoObj.videoWidth;self.nativeVideoHeight=videoObj.videoHeight;if(self._desiredVideoProperties.height&&(self.nativeVideoHeight!==self._desiredVideoProperties.height||self.nativeVideoWidth!==self._desiredVideoProperties.width)){self.showError(self.errCodes.MEDIA_WARNING,self.format(self.getConstantString("resolutionWarning"),self._desiredVideoProperties.width,self._desiredVideoProperties.height,self.nativeVideoWidth,self.nativeVideoHeight))}self.clearMediaStream(videoObj);if(videoObj.removeNode){videoObj.removeNode(true)}else{document.body.removeChild(videoObj)}updateConfigurationInfo();if(successCallback){successCallback(stream)}}else{triesLeft-=1;setTimeout(tryToGetSize,300)}};self.setVideoObjectSrc(videoObj,stream);tryToGetSize()}else{updateConfigurationInfo();if(successCallback){successCallback(stream)}}};var onUserMediaError=function(error){logDebug("getusermedia failed");logDebug("failed to get local media");var errText;if(typeof error==="string"){errText=error}else if(error.name){errText=error.name}else{errText="Unknown"}if(errorCallback){logDebug("invoking error callback",errText);errorCallback(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("gumFailed"),errText))}closeLocalMediaStreamByName(streamName);haveAudioVideo={audio:false,video:false};updateConfigurationInfo()};if(!self.audioEnabled&&!self.videoEnabled){onUserMediaError(self.getConstantString("requireAudioOrVideo"));return}function getCurrentTime(){return(new Date).getTime()}var firstCallTime;function tryAgain(err){var currentTime=getCurrentTime();if(currentTime<firstCallTime+1e3){logDebug("Trying getUserMedia a second time");navigator.mediaDevices.getUserMedia(mode).then(onUserMediaSuccess).catch(onUserMediaError)}else{onUserMediaError(err)}}firstCallTime=getCurrentTime();navigator.mediaDevices.getUserMedia(mode).then(onUserMediaSuccess).catch(tryAgain)};this.setAcceptChecker=function(acceptCheck){self.acceptCheck=acceptCheck};this.setStreamAcceptor=function(acceptor){self.streamAcceptor=acceptor};self.setOnError=function(errListener){self.onError=errListener};this.setCallCancelled=function(callCancelled){self.callCancelled=callCancelled};this.setOnStreamClosed=function(onStreamClosed){self.onStreamClosed=onStreamClosed};this.setPeerListener=function(listener,msgType,source){if(!msgType){receivePeer.cb=listener}else{if(!receivePeer.msgTypes[msgType]){receivePeer.msgTypes[msgType]={sources:{}}}if(!source){receivePeer.msgTypes[msgType].cb=listener}else{receivePeer.msgTypes[msgType].sources[source]={cb:listener}}}};this.receivePeerDistribute=function(easyrtcid,msg,targeting){var msgType=msg.msgType;var msgData=msg.msgData;if(!msgType){logDebug("received peer message without msgType",msg);return}if(receivePeer.msgTypes[msgType]){if(receivePeer.msgTypes[msgType].sources[easyrtcid]&&receivePeer.msgTypes[msgType].sources[easyrtcid].cb){receivePeer.msgTypes[msgType].sources[easyrtcid].cb(easyrtcid,msgType,msgData,targeting);return}if(receivePeer.msgTypes[msgType].cb){receivePeer.msgTypes[msgType].cb(easyrtcid,msgType,msgData,targeting);return}}if(receivePeer.cb){receivePeer.cb(easyrtcid,msgType,msgData,targeting)}};this.setServerListener=function(listener){receiveServerCB=listener};this.setSocketUrl=function(socketUrl,options){logDebug("WebRTC signaling server URL set to "+socketUrl);serverPath=socketUrl;if(options){connectionOptions=options}};this.setUsername=function(username){if(self.myEasyrtcid){self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setUsername called after authentication");return false}else if(self.isNameValid(username)){self.username=username;return true}else{self.showError(self.errCodes.BAD_NAME,self.format(self.getConstantString("badUserName"),username));return false}};this.usernameToIds=function(username,room){var results=[];var id,roomName;for(roomName in lastLoggedInList){if(!lastLoggedInList.hasOwnProperty(roomName)){continue}if(room&&roomName!==room){continue}for(id in lastLoggedInList[roomName]){if(!lastLoggedInList[roomName].hasOwnProperty(id)){continue}if(lastLoggedInList[roomName][id].username===username){results.push({easyrtcid:id,roomName:roomName})}}}return results};this.getRoomApiField=function(roomName,easyrtcid,fieldName){if(lastLoggedInList[roomName]&&lastLoggedInList[roomName][easyrtcid]&&lastLoggedInList[roomName][easyrtcid].apiField&&lastLoggedInList[roomName][easyrtcid].apiField[fieldName]){return lastLoggedInList[roomName][easyrtcid].apiField[fieldName].fieldValue}else{return undefined}};this.setCredential=function(credentialParm){try{JSON.stringify(credentialParm);credential=credentialParm;return true}catch(oops){self.showError(self.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object");throw"easyrtc.setCredential passed a non-JSON-able object"}};this.setDisconnectListener=function(disconnectListener){self.disconnectListener=disconnectListener};this.idToName=function(easyrtcid){var roomName;for(roomName in lastLoggedInList){if(!lastLoggedInList.hasOwnProperty(roomName)){continue}if(lastLoggedInList[roomName][easyrtcid]){if(lastLoggedInList[roomName][easyrtcid].username){return lastLoggedInList[roomName][easyrtcid].username}}}return easyrtcid};this.webSocket=null;var pc_config={};var pc_config_to_use=null;var use_fresh_ice_each_peer=false;this.setUseFreshIceEachPeerConnection=function(value){use_fresh_ice_each_peer=value};this.getServerIce=function(){return pc_config};this.setIceUsedInCalls=function(ice){if(!ice.iceServers){self.showError(self.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")}else{pc_config_to_use=ice}};function getRemoteStreamByName(peerConn,otherUser,streamName){var keyToMatch=null;var remoteStreams=peerConn.pc.getRemoteStreams();if(!streamName){streamName="default"}if(streamName==="default"){if(remoteStreams.length>0){return remoteStreams[0]}else{return null}}for(var roomName in self.roomData){if(self.roomData.hasOwnProperty(roomName)){var mediaIds=self.getRoomApiField(roomName,otherUser,"mediaIds");keyToMatch=mediaIds?mediaIds[streamName]:null;if(keyToMatch){break}}}if(!keyToMatch){self.showError(self.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+streamName)}for(var i=0;i<remoteStreams.length;i++){var remoteId;if(remoteStreams[i].id){remoteId=remoteStreams[i].id}else{remoteId="default"}if(!keyToMatch||remoteId===keyToMatch||remoteId.indexOf(keyToMatch)===0){return remoteStreams[i]}}return null}function _haveTracks(easyrtcid,checkAudio,streamName){var stream,peerConnObj;if(!easyrtcid){stream=getLocalMediaStreamByName(streamName)}else{peerConnObj=peerConns[easyrtcid];if(!peerConnObj){self.showError(self.errCodes.DEVELOPER_ERR,"haveTracks called about a peer you don't have a connection to");return false}stream=getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,streamName)}if(!stream){return false}var tracks;try{if(checkAudio){tracks=stream.getAudioTracks()}else{tracks=stream.getVideoTracks()}}catch(oops){return true}if(!tracks){return false}return tracks.length>0}this.haveAudioTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,true,streamName)};this.haveVideoTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,false,streamName)};this.getRoomField=function(roomName,fieldName){var fields=self.getRoomFields(roomName);return!fields||!fields[fieldName]?undefined:fields[fieldName].fieldValue};var fields=null;var preallocatedSocketIo=null;var closedChannel=null;function disconnectBody(){var roomName;self.loggingOut=true;offersPending={};acceptancePending={};self.disconnecting=true;closedChannel=self.webSocket;if(stillAliveTimer){clearTimeout(stillAliveTimer);stillAliveTimer=null}if(self.webSocket){if(!preallocatedSocketIo){self.webSocket.close()}}self.webSocketConnected=false;self.webSocket=0;self.hangupAll();if(roomOccupantListener){for(roomName in lastLoggedInList){if(lastLoggedInList.hasOwnProperty(roomName)){roomOccupantListener(roomName,{},false);self.setRoomApiField(roomName)}}}lastLoggedInList={};self.emitEvent("roomOccupant",{});self.roomData={};self.roomJoin={};self.loggingOut=false;self.myEasyrtcid=null;self.disconnecting=false;oldConfig={};if(self.disconnectListener){self.disconnectListener()}}this.disconnect=function(){logDebug("attempt to disconnect from WebRTC signalling server");self.disconnecting=true;self.hangupAll();self.loggingOut=true;setTimeout(disconnectBody,250)};function sendSignalling(destUser,msgType,msgData,successCallback,errorCallback){if(!self.webSocket){throw"Attempt to send message without a valid connection to the server."}else{var dataToShip={msgType:msgType};if(destUser){dataToShip.targetEasyrtcid=destUser}if(msgData){dataToShip.msgData=msgData}logDebug("sending socket message "+JSON.stringify(dataToShip));self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){if(ackMsg.msgType!=="error"){if(!ackMsg.hasOwnProperty("msgData")){ackMsg.msgData=null}if(successCallback){successCallback(ackMsg.msgType,ackMsg.msgData)}}else{if(errorCallback){errorCallback(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)}else{self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)}}})}}var sendByChunkUidCounter=0;function sendByChunkHelper(destUser,msgData){var transferId=destUser+"-"+sendByChunkUidCounter++;var pos,len,startMessage,message,endMessage;var numberOfChunks=Math.ceil(msgData.length/self.maxP2PMessageLength);startMessage={transfer:"start",transferId:transferId,parts:numberOfChunks};endMessage={transfer:"end",transferId:transferId};peerConns[destUser].dataChannelS.send(JSON.stringify(startMessage));for(pos=0,len=msgData.length;pos<len;pos+=self.maxP2PMessageLength){message={transferId:transferId,data:msgData.substr(pos,self.maxP2PMessageLength),transfer:"chunk"};peerConns[destUser].dataChannelS.send(JSON.stringify(message))}peerConns[destUser].dataChannelS.send(JSON.stringify(endMessage))}this.sendDataP2P=function(destUser,msgType,msgData){var flattenedData=JSON.stringify({msgType:msgType,msgData:msgData});logDebug("sending p2p message to "+destUser+" with data="+JSON.stringify(flattenedData));if(!peerConns[destUser]){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+destUser+" first.")}else if(!peerConns[destUser].dataChannelS){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+destUser+" first.")}else if(!peerConns[destUser].dataChannelReady){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+destUser+" before it's ready to send.")}else{try{if(flattenedData.length>self.maxP2PMessageLength){sendByChunkHelper(destUser,flattenedData)}else{peerConns[destUser].dataChannelS.send(flattenedData)}}catch(sendDataErr){logDebug("sendDataP2P error: ",sendDataErr);throw sendDataErr}}};this.sendDataWS=function(destination,msgType,msgData,ackhandler){logDebug("sending client message via websockets to "+destination+" with data="+JSON.stringify(msgData));if(!ackhandler){ackhandler=function(msg){if(msg.msgType==="error"){self.showError(msg.msgData.errorCode,msg.msgData.errorText)}}}var outgoingMessage={msgType:msgType,msgData:msgData};if(destination){if(typeof destination==="string"){outgoingMessage.targetEasyrtcid=destination}else if(typeof destination==="object"){if(destination.targetEasyrtcid){outgoingMessage.targetEasyrtcid=destination.targetEasyrtcid}if(destination.targetRoom){outgoingMessage.targetRoom=destination.targetRoom}if(destination.targetGroup){outgoingMessage.targetGroup=destination.targetGroup}}}if(self.webSocket){self.webSocket.json.emit("easyrtcMsg",outgoingMessage,ackhandler)}else{logDebug("websocket failed because no connection to server");throw"Attempt to send message without a valid connection to the server."}};this.sendData=function(destUser,msgType,msgData,ackHandler){if(peerConns[destUser]&&peerConns[destUser].dataChannelReady){self.sendDataP2P(destUser,msgType,msgData)}else{self.sendDataWS(destUser,msgType,msgData,ackHandler)}};this.sendPeerMessage=function(destination,msgType,msgData,successCB,failureCB){if(!destination){self.showError(self.errCodes.DEVELOPER_ERR,"destination was null in sendPeerMessage")}logDebug("sending peer message "+JSON.stringify(msgData));function ackHandler(response){if(response.msgType==="error"){if(failureCB){failureCB(response.msgData.errorCode,response.msgData.errorText)}}else{if(successCB){successCB(response.msgType,response.msgData?response.msgData:null)}}}self.sendDataWS(destination,msgType,msgData,ackHandler)};this.sendServerMessage=function(msgType,msgData,successCB,failureCB){var dataToShip={msgType:msgType,msgData:msgData};logDebug("sending server message "+JSON.stringify(dataToShip));function ackhandler(response){if(response.msgType==="error"){if(failureCB){failureCB(response.msgData.errorCode,response.msgData.errorText)}}else{if(successCB){successCB(response.msgType,response.msgData?response.msgData:null)}}}self.sendDataWS(null,msgType,msgData,ackhandler)};this.getRoomList=function(callback,errorCallback){sendSignalling(null,"getRoomList",null,function(msgType,msgData){callback(msgData.roomList)},function(errorCode,errorText){if(errorCallback){errorCallback(errorCode,errorText)}else{self.showError(errorCode,errorText)}})};this.NOT_CONNECTED="not connected";this.BECOMING_CONNECTED="connection in progress to us.";this.IS_CONNECTED="is connected";this.getConnectStatus=function(otherUser){if(!peerConns.hasOwnProperty(otherUser)){return self.NOT_CONNECTED}var peer=peerConns[otherUser];if((peer.sharingAudio||peer.sharingVideo)&&!peer.startedAV){return self.BECOMING_CONNECTED}else if(peer.sharingData&&!peer.dataChannelReady){return self.BECOMING_CONNECTED}else{return self.IS_CONNECTED}};function buildPeerConstraints(){var options=[];options.push({DtlsSrtpKeyAgreement:"true"});return{optional:options}}function sendQueuedCandidates(peer,onSignalSuccess,onSignalFailure){var i;for(i=0;i<peerConns[peer].candidatesToSend.length;i++){sendSignalling(peer,"candidate",peerConns[peer].candidatesToSend[i],onSignalSuccess,onSignalFailure)}}function emitOnStreamClosed(easyrtcid,stream){if(!peerConns[easyrtcid]){return}var streamId=stream.id||"default",streamName=getNameOfRemoteStream(easyrtcid,streamId)||"default";if(peerConns[easyrtcid].liveRemoteStreams[streamName]){delete peerConns[easyrtcid].liveRemoteStreams[streamName];if(self.onStreamClosed){self.onStreamClosed(easyrtcid,stream,streamName)}}delete peerConns[easyrtcid].remoteStreamIdToName[streamId]}function onRemoveStreamHelper(easyrtcid,stream){if(peerConns[easyrtcid]){emitOnStreamClosed(easyrtcid,stream);updateConfigurationInfo();if(peerConns[easyrtcid].pc){try{peerConns[easyrtcid].pc.removeStream(stream)}catch(err){}}}}function buildDeltaRecord(added,deleted){function objectNotEmpty(obj){var i;for(i in obj){if(obj.hasOwnProperty(i)){return true}}return false}var result={};if(objectNotEmpty(added)){result.added=added}if(objectNotEmpty(deleted)){result.deleted=deleted}if(objectNotEmpty(result)){return result}else{return null}}function findDeltas(oldVersion,newVersion){var i;var added={},deleted={};var subPart;for(i in newVersion){if(newVersion.hasOwnProperty(i)){if(oldVersion===null||typeof oldVersion[i]==="undefined"){added[i]=newVersion[i]}else if(typeof newVersion[i]==="object"){subPart=findDeltas(oldVersion[i],newVersion[i]);if(subPart!==null){added[i]=newVersion[i]}}else if(newVersion[i]!==oldVersion[i]){added[i]=newVersion[i]}}}for(i in oldVersion){if(newVersion.hasOwnProperty(i)){if(typeof newVersion[i]==="undefined"){deleted[i]=oldVersion[i]}}}return buildDeltaRecord(added,deleted)}function collectConfigurationInfo(){var p2pList={};var i;for(i in peerConns){if(!peerConns.hasOwnProperty(i)){continue}p2pList[i]={connectTime:peerConns[i].connectTime,isInitiator:!!peerConns[i].isInitiator}}var newConfig={userSettings:{sharingAudio:!!haveAudioVideo.audio,sharingVideo:!!haveAudioVideo.video,sharingData:!!dataEnabled,nativeVideoWidth:self.nativeVideoWidth,nativeVideoHeight:self.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};if(!isEmptyObj(p2pList)){newConfig.p2pList=p2pList}return newConfig}function updateConfiguration(){var newConfig=collectConfigurationInfo(false);var sendDeltas=function(){var alteredData=findDeltas(oldConfig,newConfig);if(alteredData){logDebug("cfg="+JSON.stringify(alteredData.added));if(self.webSocket){sendSignalling(null,"setUserCfg",{setUserCfg:alteredData.added},null,null)}}oldConfig=newConfig};if(oldConfig==={}){sendDeltas()}else{setTimeout(sendDeltas,100)}}function formatPriority(priority){var s="";s+=priority>>24;s+=" | ";s+=priority>>8&65535;s+=" | ";s+=priority&255;return s}function parseCandidate(text){var candidateStr="candidate:";var pos=text.indexOf(candidateStr)+candidateStr.length;var fields=text.substr(pos).split(" ");return{component:fields[1],type:fields[7],foundation:fields[0],protocol:fields[2],address:fields[4],port:fields[5],priority:formatPriority(fields[3])}}function processCandidate(candidate){self._candidates=self._candidates||[];self._candidates.push(parseCandidate(candidate))}function processAddedStream(otherUser,peerStream){if(!peerConns[otherUser]||peerConns[otherUser].cancelled){return}var peerConn=peerConns[otherUser];if(!peerConn.startedAV){peerConn.startedAV=true;peerConn.sharingAudio=haveAudioVideo.audio;peerConn.sharingVideo=haveAudioVideo.video;peerConn.connectTime=(new Date).getTime();if(peerConn.callSuccessCB){if(peerConn.sharingAudio||peerConn.sharingVideo){peerConn.callSuccessCB(otherUser,"audiovideo")}}if(self.audioEnabled||self.videoEnabled){updateConfiguration()}}var streamId=peerStream.id||"default";var remoteName=getNameOfRemoteStream(otherUser,streamId)||"default";if(!peerConn.liveRemoteStreams[remoteName]){peerConn.remoteStreamIdToName[streamId]=remoteName;peerConn.liveRemoteStreams[remoteName]=true;peerStream.streamName=remoteName;var tracks=peerStream.getTracks();peerStream.addEventListener("removetrack",function(e){var trackIndex=tracks.indexOf(e.track);if(trackIndex!==-1){tracks.splice(trackIndex,1)}if(tracks.length===0){emitOnStreamClosed(otherUser,peerStream)}});if(self.streamAcceptor){self.streamAcceptor(otherUser,peerStream,remoteName);self.sendDataWS(otherUser,"easyrtc_streamReceived",{streamName:remoteName},function(){})}}else{logDebug("Remote stream "+remoteName+" already exist")}}function processAddedTrack(otherUser,peerStreams){if(!peerConns[otherUser]||peerConns[otherUser].cancelled){return}var peerConn=peerConns[otherUser];peerConn.trackTimers=peerConn.trackTimers||{};for(var i=0,l=peerStreams.length;i<l;i++){var peerStream=peerStreams[i],streamId=peerStream.id||"default";clearTimeout(peerConn.trackTimers[streamId]);peerConn.trackTimers[streamId]=setTimeout(processAddedStream.bind(null,otherUser,peerStream),100)}}function buildPeerConnection(otherUser,isInitiator,failureCB,streamNames){var pc;var message;var newPeerConn;var iceConfig=pc_config_to_use?pc_config_to_use:pc_config;logDebug("building peer connection to "+otherUser);try{pc=self.createRTCPeerConnection(iceConfig,buildPeerConstraints());if(!pc){message="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(iceConfig)+")";logDebug(message);throw Error(message)}if(dataEnabled&&typeof pc.createDataChannel==="undefined"){dataEnabled=false}pc.onnegotiationneeded=function(event){var eventTarget=event.currentTarget||event.target||pc,signalingState=eventTarget.signalingState||"unknown";logDebug("onnegotiationneeded",signalingState);if(peerConns[otherUser]&&peerConns[otherUser].enableNegotiateListener){initiateSendOffer(otherUser)}};pc.onsignalingstatechange=function(){var eventTarget=event.currentTarget||event.target||pc,signalingState=eventTarget.signalingState||"unknown";logDebug("onsignalingstatechange",signalingState);if(signalingStateChangeListener){signalingStateChangeListener(otherUser,eventTarget,signalingState)}};pc.oniceconnectionstatechange=function(event){var eventTarget=event.currentTarget||event.target||pc,connState=eventTarget.iceConnectionState||"unknown";logDebug("onsignalingstatechange",connState);if(iceConnectionStateChangeListener){iceConnectionStateChangeListener(otherUser,eventTarget,connState)}switch(connState){case"connected":if(self.onPeerOpen){self.onPeerOpen(otherUser)}if(peerConns[otherUser]&&peerConns[otherUser].callSuccessCB){peerConns[otherUser].callSuccessCB(otherUser,"connection")}break;case"failed":if(failureCB){failureCB(self.errCodes.NOVIABLEICE,"No usable STUN/TURN path")}delete peerConns[otherUser];break;case"disconnected":if(self.onPeerFailing){self.onPeerFailing(otherUser)}if(peerConns[otherUser]){peerConns[otherUser].failing=Date.now()}break;case"closed":if(self.onPeerClosed){self.onPeerClosed(otherUser)}break;case"completed":if(peerConns[otherUser]){if(peerConns[otherUser].failing&&self.onPeerRecovered){self.onPeerRecovered(otherUser,peerConns[otherUser].failing,Date.now())}delete peerConns[otherUser].failing}break}};pc.onconnection=function(){logDebug("onconnection called prematurely")};newPeerConn={pc:pc,candidatesToSend:[],startedAV:false,connectionAccepted:false,isInitiator:isInitiator,remoteStreamIdToName:{},streamsAddedAcks:{},liveRemoteStreams:{},supportHalfTrickleIce:false};pc.onicecandidate=function(event){if(peerConns[otherUser]&&peerConns[otherUser].cancelled){return}var candidateData;if(event.candidate&&peerConns[otherUser]){candidateData={type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate};if(iceCandidateFilter){candidateData=iceCandidateFilter(candidateData,false);if(!candidateData){return}}processCandidate(event.candidate.candidate);if(peerConns[otherUser].connectionAccepted||peerConns[otherUser].supportHalfTrickleIce){sendSignalling(otherUser,"candidate",candidateData,null,function(){failureCB(self.errCodes.PEER_GONE,"Candidate disappeared")})}else{peerConns[otherUser].candidatesToSend.push(candidateData)}}};pc.ontrack=function(event){logDebug("saw ontrack method invoked, which is expected");processAddedTrack(otherUser,event.streams)};pc.onaddstream=function(event){logDebug("empty onaddstream method invoked, which is expected");processAddedStream(otherUser,event.stream)};pc.onremovestream=function(event){logDebug("saw remove on remote media stream");onRemoveStreamHelper(otherUser,event.stream)};peerConns[otherUser]=newPeerConn}catch(error){logDebug("buildPeerConnection error",error);failureCB(self.errCodes.SYSTEM_ERR,error.message);return null}var i,stream;if(streamNames){for(i=0;i<streamNames.length;i++){stream=getLocalMediaStreamByName(streamNames[i]);if(stream){addStreamToPeerConnection(stream,pc)}else{logDebug("Developer error, attempt to access unknown local media stream "+streamNames[i])}}}else if(autoInitUserMedia&&(self.videoEnabled||self.audioEnabled)){stream=self.getLocalStream();addStreamToPeerConnection(stream,pc)}var pendingTransfer={};function dataChannelMessageHandler(event){logDebug("saw dataChannel.onmessage event: ",event.data);if(event.data==="dataChannelPrimed"){self.sendDataWS(otherUser,"dataChannelPrimed","")}else{var msg;try{msg=JSON.parse(event.data)}catch(err){logDebug("Developer error, unable to parse event data")}if(msg){if(msg.transfer&&msg.transferId){if(msg.transfer==="start"){logDebug("start transfer #"+msg.transferId);var parts=parseInt(msg.parts);pendingTransfer={chunks:[],parts:parts,transferId:msg.transferId}}else if(msg.transfer==="chunk"){logDebug("got chunk for transfer #"+msg.transferId);if(!(typeof msg.data==="string"&&msg.data.length<=self.maxP2PMessageLength)){logDebug("Developer error, invalid data")}else if(!pendingTransfer){logDebug("Developer error, unexpected chunk")}else if(msg.transferId!==pendingTransfer.transferId){logDebug("Developer error, invalid transfer id")}else if(pendingTransfer.chunks.length+1>pendingTransfer.parts){logDebug("Developer error, received too many chunks")}else{pendingTransfer.chunks.push(msg.data)}}else if(msg.transfer==="end"){logDebug("end of transfer #"+msg.transferId);if(!pendingTransfer){logDebug("Developer error, unexpected end of transfer")}else if(msg.transferId!==pendingTransfer.transferId){logDebug("Developer error, invalid transfer id")}else if(pendingTransfer.chunks.length!==pendingTransfer.parts){logDebug("Developer error, received wrong number of chunks")}else{var chunkedMsg;try{chunkedMsg=JSON.parse(pendingTransfer.chunks.join(""))}catch(err){logDebug("Developer error, unable to parse message")}if(chunkedMsg){self.receivePeerDistribute(otherUser,chunkedMsg,null)}}pendingTransfer={}}else{logDebug("Developer error, got an unknown transfer message"+msg.transfer)}}else{self.receivePeerDistribute(otherUser,msg,null)}}}}function initOutGoingChannel(otherUser){logDebug("saw initOutgoingChannel call");var dataChannel=pc.createDataChannel(dataChannelName,self.getDatachannelConstraints());peerConns[otherUser].dataChannelS=dataChannel;peerConns[otherUser].dataChannelR=dataChannel;dataChannel.onmessage=dataChannelMessageHandler;dataChannel.onopen=function(event){logDebug("saw dataChannel.onopen event");if(peerConns[otherUser]){dataChannel.send("dataChannelPrimed")}};dataChannel.onclose=function(event){logDebug("saw dataChannelS.onclose event");if(peerConns[otherUser]){peerConns[otherUser].dataChannelReady=false;delete peerConns[otherUser].dataChannelS}if(onDataChannelClose){onDataChannelClose(otherUser)}updateConfigurationInfo()}}function initIncomingChannel(otherUser){logDebug("initializing incoming channel handler for "+otherUser);peerConns[otherUser].pc.ondatachannel=function(event){logDebug("saw incoming data channel");var dataChannel=event.channel;peerConns[otherUser].dataChannelR=dataChannel;peerConns[otherUser].dataChannelS=dataChannel;peerConns[otherUser].dataChannelReady=true;dataChannel.onmessage=dataChannelMessageHandler;dataChannel.onclose=function(event){logDebug("saw dataChannelR.onclose event");if(peerConns[otherUser]){peerConns[otherUser].dataChannelReady=false;delete peerConns[otherUser].dataChannelR}if(onDataChannelClose){onDataChannelClose(otherUser)}updateConfigurationInfo()};dataChannel.onopen=function(event){logDebug("saw dataChannel.onopen event");if(peerConns[otherUser]){dataChannel.send("dataChannelPrimed")}}}}if(dataEnabled){self.setPeerListener(function(){if(peerConns[otherUser]){peerConns[otherUser].dataChannelReady=true;if(peerConns[otherUser].callSuccessCB){peerConns[otherUser].callSuccessCB(otherUser,"datachannel")}if(onDataChannelOpen){onDataChannelOpen(otherUser,true)}updateConfigurationInfo()}else{logDebug("failed to setup outgoing channel listener")}},"dataChannelPrimed",otherUser);if(isInitiator){try{initOutGoingChannel(otherUser)}catch(channelErrorEvent){logDebug("failed to init outgoing channel");failureCB(self.errCodes.SYSTEM_ERR,self.formatError(channelErrorEvent))}}if(!isInitiator){initIncomingChannel(otherUser)}}pc.onconnection=function(){logDebug("setup pc.onconnection ")};self.setPeerListener(function(easyrtcid,msgType,msgData,targeting){if(newPeerConn.streamsAddedAcks[msgData.streamName]){newPeerConn.streamsAddedAcks[msgData.streamName](easyrtcid,msgData.streamName);delete newPeerConn.streamsAddedAcks[msgData.streamName]}},"easyrtc_streamReceived",otherUser);return pc}function doAnswerBody(caller,msgData,streamNames){if(!peerConns[caller]){buildPeerConnection(caller,false,function(message){self.showError(self.errCodes.SYSTEM_ERR,message)},streamNames)}var newPeerConn=peerConns[caller];var pc=newPeerConn.pc;if(!pc){logDebug("buildPeerConnection failed. Call not answered");return}var setLocalAndSendMessage1=function(sessionDescription){if(newPeerConn.cancelled){return}var sendAnswer=function(){logDebug("sending answer");function onSignalSuccess(){logDebug("sending success")}function onSignalFailure(errorCode,errorText){logDebug("sending error");delete peerConns[caller];self.showError(errorCode,errorText)}newPeerConn.pendingAwnser=false;sendSignalling(caller,"answer",sessionDescription,onSignalSuccess,onSignalFailure);peerConns[caller].connectionAccepted=true;sendQueuedCandidates(caller,onSignalSuccess,onSignalFailure);if(pc.connectDataConnection){logDebug("calling connectDataConnection(5002,5001)");pc.connectDataConnection(5002,5001)}};if(sdpLocalFilter){sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)}pc.setLocalDescription(sessionDescription).then(sendAnswer,function(message){newPeerConn.pendingAwnser=false;self.showError(self.errCodes.INTERNAL_ERR,"setLocalDescription: "+message)})};var sd=new RTCSessionDescription(msgData);if(!sd){throw"Could not create the RTCSessionDescription"}logDebug("sdp ||  "+JSON.stringify(sd));var invokeCreateAnswer=function(){if(newPeerConn.cancelled){logDebug("invokeCreateAnswer.canceled",pc.signalingState);return}if(newPeerConn.pendingAwnser){logDebug("invokeCreateAnswer.pending",pc.signalingState)}logDebug("invokeCreateAnswer",pc.signalingState);newPeerConn.pendingAwnser=true;pc.createAnswer(receivedMediaConstraints).then(setLocalAndSendMessage1).catch(function(reason){newPeerConn.pendingAwnser=false;self.showError(self.errCodes.INTERNAL_ERR,"create-answer: "+reason)})};logDebug("about to call setRemoteDescription in doAnswer");try{if(sdpRemoteFilter){sd=new RTCSessionDescription({type:sd.type,sdp:sdpRemoteFilter(sd.sdp)})}logDebug("sdp ||  "+JSON.stringify(sd));pc.setRemoteDescription(sd).then(invokeCreateAnswer,function(message){self.showError(self.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription failed: "+message)})}catch(srdError){logDebug("set remote description failed");self.showError(self.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription error: "+srdError.message)}}function doAnswer(caller,msgData,streamNames){if(!streamNames&&autoInitUserMedia){var localStream=self.getLocalStream();if(!localStream&&(self.videoEnabled||self.audioEnabled)){self.initMediaSource(function(){doAnswer(caller,msgData)},function(errorCode,error){self.showError(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("localMediaError")))});return}}if(use_fresh_ice_each_peer){self.getFreshIceConfig(function(succeeded){if(succeeded){doAnswerBody(caller,msgData,streamNames)}else{self.showError(self.errCodes.CALL_ERR,"Failed to get fresh ice config")}})}else{doAnswerBody(caller,msgData,streamNames)}}function callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){acceptancePending[otherUser]=true;var pc=buildPeerConnection(otherUser,true,callFailureCB,streamNames);var message;if(!pc){message="buildPeerConnection failed, call not completed";logDebug(message);throw message}peerConns[otherUser].callSuccessCB=callSuccessCB;peerConns[otherUser].callFailureCB=callFailureCB;peerConns[otherUser].wasAcceptedCB=wasAcceptedCB;initiateSendOffer(otherUser)}function initiateSendOffer(otherUser){var peerConnObj=peerConns[otherUser];if(!peerConnObj){logDebug("message attempt to send offer for nonexistent peer connection "+otherUser);return}var pc=peerConnObj.pc;var callFailureCB=peerConnObj.callFailureCB||self.showError;var setLocalAndSendMessage0=function(sessionDescription){if(peerConnObj.cancelled){logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.cancelled,peerConnObj.sendingOffer);return}var sendOffer=function(){peerConnObj.sendingOffer=false;sendSignalling(otherUser,"offer",sessionDescription,null,peerConnObj.callFailureCB)};if(sdpLocalFilter){sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)}pc.setLocalDescription(sessionDescription).then(sendOffer,function(errorText){peerConnObj.sendingOffer=false;callFailureCB(self.errCodes.CALL_ERR,errorText)})};if(peerConnObj.sendingOffer){logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.sendingOffer);return}peerConnObj.sendingOffer=true;pc.createOffer(receivedMediaConstraints).then(setLocalAndSendMessage0).catch(function(errorObj){peerConnObj.sendingOffer=false;callFailureCB(self.errCodes.CALL_ERR,JSON.stringify(errorObj))})}this.call=function(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){if(streamNames){if(typeof streamNames==="string"){streamNames=[streamNames]}else if(typeof streamNames.length==="undefined"){self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");return}}logDebug("initiating peer to peer call to "+otherUser+" audio="+self.audioEnabled+" video="+self.videoEnabled+" data="+dataEnabled);if(!self.supportsPeerConnections()){callFailureCB(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"));return}var message;if(!streamNames&&autoInitUserMedia){var stream=self.getLocalStream();if(!stream&&(self.audioEnabled||self.videoEnabled)){self.initMediaSource(function(){self.call(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB)},callFailureCB);return}}if(!self.webSocket){message="Attempt to make a call prior to connecting to service";logDebug(message);throw message}if(offersPending[otherUser]){wasAcceptedCB(true,otherUser);doAnswer(otherUser,offersPending[otherUser],streamNames);self.callCancelled(otherUser,false)}else if(typeof acceptancePending[otherUser]!=="undefined"){message="Call already pending acceptance";logDebug(message);callFailureCB(self.errCodes.ALREADY_CONNECTED,message)}else if(use_fresh_ice_each_peer){self.getFreshIceConfig(function(succeeded){if(succeeded){callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames)}else{callFailureCB(self.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}})}else{callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames)}};function isStreamActive(stream){var isActive;if(stream.active===true||stream.ended===false){isActive=true}else{isActive=stream.getTracks().reduce(function(track){return track.enabled})}return isActive}var queuedMessages={};function clearQueuedMessages(caller){queuedMessages[caller]={candidates:[]}}function closePeer(otherUser){if(acceptancePending[otherUser]){delete acceptancePending[otherUser]}if(offersPending[otherUser]){delete offersPending[otherUser]}if(!peerConns[otherUser].cancelled&&peerConns[otherUser].pc){try{peerConns[otherUser].cancelled=true;var remoteStreams=peerConns[otherUser].pc.getRemoteStreams();for(var i=0;i<remoteStreams.length;i++){if(isStreamActive(remoteStreams[i])){emitOnStreamClosed(otherUser,remoteStreams[i]);stopStream(remoteStreams[i])}}peerConns[otherUser].pc.close();logDebug("peer closed")}catch(err){logDebug("peer "+otherUser+" close failed:"+err)}finally{if(self.onPeerClosed){self.onPeerClosed(otherUser)}}}}function hangupBody(otherUser){logDebug("Hanging up on "+otherUser);clearQueuedMessages(otherUser);if(peerConns[otherUser]){if(peerConns[otherUser].pc){closePeer(otherUser)}if(peerConns[otherUser]){delete peerConns[otherUser]}updateConfigurationInfo();if(self.webSocket){sendSignalling(otherUser,"hangup",null,function(){logDebug("hangup succeeds")},function(errorCode,errorText){logDebug("hangup failed:"+errorText);self.showError(errorCode,errorText)})}}}this.hangup=function(otherUser){hangupBody(otherUser);updateConfigurationInfo()};this.hangupAll=function(){var sawAConnection=false;for(var otherUser in peerConns){if(!peerConns.hasOwnProperty(otherUser)){continue}sawAConnection=true;hangupBody(otherUser)}if(sawAConnection){updateConfigurationInfo()}};this.doesDataChannelWork=function(otherUser){if(!peerConns[otherUser]){return false}return!!peerConns[otherUser].dataChannelReady};this.getRemoteStream=function(easyrtcid,remoteStreamName){if(!peerConns[easyrtcid]){self.showError(self.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party");throw"Developer err: no such stream"}else{return getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,remoteStreamName)}};this.makeLocalStreamFromRemoteStream=function(easyrtcid,remoteStreamName,localStreamName){var remoteStream;if(peerConns[easyrtcid].pc){remoteStream=getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,remoteStreamName);if(remoteStream){registerLocalMediaStreamByName(remoteStream,localStreamName)}else{throw"Developer err: no such stream"}}else{throw"Developer err: no such peer "}};this.addStreamToCall=function(easyrtcId,streamName,receiptHandler){if(!streamName){streamName="default"}var stream=getLocalMediaStreamByName(streamName);if(!stream){logDebug("attempt to add nonexistent stream "+streamName)}else if(!peerConns[easyrtcId]||!peerConns[easyrtcId].pc){logDebug("Can't add stream before a call has started.")}else{var pc=peerConns[easyrtcId].pc;peerConns[easyrtcId].enableNegotiateListener=true;addStreamToPeerConnection(stream,pc);if(receiptHandler){peerConns[easyrtcId].streamsAddedAcks[streamName]=receiptHandler}}};this.removeStreamFromCall=function(easyrtcId,streamName){if(!streamName){streamName="default"}var stream=getLocalMediaStreamByName(streamName);if(!stream){logDebug("attempt to remove nonexistent stream "+streamName)}else if(!peerConns[easyrtcId]||!peerConns[easyrtcId].pc){logDebug("Can't remove stream before a call has started.")}else{var pc=peerConns[easyrtcId].pc;peerConns[easyrtcId].enableNegotiateListener=true;pc.removeStream(stream)}};this.dumpPeerConnectionInfo=function(){var i;for(var peer in peerConns){if(peerConns.hasOwnProperty(peer)){var pc=peerConns[peer].pc;var remotes=pc.getRemoteStreams();var remoteIds=[];for(i=0;i<remotes.length;i++){remoteIds.push(remotes[i].id)}var locals=pc.getLocalStreams();var localIds=[];for(i=0;i<locals.length;i++){localIds.push(locals[i].id)}logDebug("For peer "+peer);logDebug("    "+JSON.stringify({local:localIds,remote:remoteIds}))}}};function onRemoteHangup(otherUser){logDebug("Saw onRemote hangup event");clearQueuedMessages(otherUser);if(peerConns[otherUser]){if(peerConns[otherUser].pc){closePeer(otherUser)}else{if(self.callCancelled){self.callCancelled(otherUser,true)}}if(peerConns[otherUser]){delete peerConns[otherUser]}}else{if(self.callCancelled){self.callCancelled(otherUser,true)}}}function isPeerInAnyRoom(id){var roomName;for(roomName in lastLoggedInList){if(!lastLoggedInList.hasOwnProperty(roomName)){continue}if(lastLoggedInList[roomName][id]){return true}}return false}this.isPeerInAnyRoom=function(easyrtcid){return isPeerInAnyRoom(easyrtcid)};function processLostPeers(peersInRoom){var id;for(id in peerConns){if(peerConns.hasOwnProperty(id)&&typeof peersInRoom[id]==="undefined"){if(!isPeerInAnyRoom(id)){if(peerConns[id].pc||peerConns[id].isInitiator){onRemoteHangup(id)}delete offersPending[id];delete acceptancePending[id];clearQueuedMessages(id)}}}for(id in offersPending){if(offersPending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)){onRemoteHangup(id);clearQueuedMessages(id);delete offersPending[id];delete acceptancePending[id]}}for(id in acceptancePending){if(acceptancePending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)){onRemoteHangup(id);clearQueuedMessages(id);delete acceptancePending[id]}}}var aggregatingTimers={};function addAggregatingTimer(key,callback,period){if(!period){period=100}var counter=0;if(aggregatingTimers[key]){clearTimeout(aggregatingTimers[key].timer);counter=aggregatingTimers[key].counter}if(counter>20){delete aggregatingTimers[key];callback()}else{aggregatingTimers[key]={counter:counter+1};aggregatingTimers[key].timer=setTimeout(function(){delete aggregatingTimers[key];callback()},period)}}function processOccupantList(roomName,occupantList){var myInfo=null;var reducedList={};var id;for(id in occupantList){if(occupantList.hasOwnProperty(id)){if(id===self.myEasyrtcid){myInfo=occupantList[id]}else{reducedList[id]=occupantList[id]}}}processLostPeers(reducedList);addAggregatingTimer("roomOccupants&"+roomName,function(){if(roomOccupantListener){roomOccupantListener(roomName,reducedList,myInfo)}self.emitEvent("roomOccupants",{roomName:roomName,occupants:lastLoggedInList})},100)}function onChannelMsg(msg,ackAcceptorFunc){var targeting={};if(ackAcceptorFunc){ackAcceptorFunc(self.ackMessage)}if(msg.targetEasyrtcid){targeting.targetEasyrtcid=msg.targetEasyrtcid}if(msg.targetRoom){targeting.targetRoom=msg.targetRoom}if(msg.targetGroup){targeting.targetGroup=msg.targetGroup}if(msg.senderEasyrtcid){self.receivePeerDistribute(msg.senderEasyrtcid,msg,targeting)}else{if(receiveServerCB){receiveServerCB(msg.msgType,msg.msgData,targeting)}else{logDebug("Unhandled server message "+JSON.stringify(msg))}}}function processUrl(url){var ipAddress;if(url.indexOf("turn:")===0||url.indexOf("turns:")===0){ipAddress=url.split(/[@:&]/g)[1];self._turnServers[ipAddress]=true}else if(url.indexOf("stun:")===0||url.indexOf("stuns:")===0){ipAddress=url.split(/[@:&]/g)[1];self._stunServers[ipAddress]=true}}function processIceConfig(iceConfig){var i,j,item;pc_config={iceServers:[]};self._turnServers={};self._stunServers={};if(!iceConfig||!iceConfig.iceServers||typeof iceConfig.iceServers.length==="undefined"){self.showError(self.errCodes.DEVELOPER_ERR,"iceConfig received from server didn't have an array called iceServers, ignoring it")}else{pc_config={iceServers:iceConfig.iceServers}}for(i=0;i<iceConfig.iceServers.length;i++){item=iceConfig.iceServers[i];if(item.urls&&item.urls.length){if(typeof item.urls==="string"){processUrl(item.urls)}else if(item.urls instanceof Array){for(j=0;j<item.urls.length;j++){processUrl(item.urls[j])}}}else if(item.url){processUrl(item.url)}}}function processSessionData(sessionData){if(sessionData){if(sessionData.easyrtcsid){self.easyrtcsid=sessionData.easyrtcsid}if(sessionData.field){sessionFields=sessionData.field}}}function processRoomData(roomData){self.roomData=roomData;var k,roomName,stuffToRemove,stuffToAdd,id,removeId;for(roomName in self.roomData){if(!self.roomData.hasOwnProperty(roomName)){continue}if(roomData[roomName].roomStatus==="join"){if(!self.roomJoin[roomName]){self.roomJoin[roomName]=roomData[roomName]}var mediaIds=buildMediaIds();if(mediaIds!=={}){self.setRoomApiField(roomName,"mediaIds",mediaIds)}}else if(roomData[roomName].roomStatus==="leave"){if(self.roomEntryListener){self.roomEntryListener(false,roomName)}delete self.roomJoin[roomName];delete lastLoggedInList[roomName];continue}if(roomData[roomName].clientList){lastLoggedInList[roomName]=roomData[roomName].clientList}else if(roomData[roomName].clientListDelta){stuffToAdd=roomData[roomName].clientListDelta.updateClient;if(stuffToAdd){for(id in stuffToAdd){if(!stuffToAdd.hasOwnProperty(id)){continue}if(!lastLoggedInList[roomName]){lastLoggedInList[roomName]=[]}if(!lastLoggedInList[roomName][id]){lastLoggedInList[roomName][id]=stuffToAdd[id]}for(k in stuffToAdd[id]){if(k==="apiField"||k==="presence"){lastLoggedInList[roomName][id][k]=stuffToAdd[id][k]}}}}stuffToRemove=roomData[roomName].clientListDelta.removeClient;if(stuffToRemove&&lastLoggedInList[roomName]){for(removeId in stuffToRemove){if(stuffToRemove.hasOwnProperty(removeId)){delete lastLoggedInList[roomName][removeId]}}}}if(self.roomJoin[roomName]&&roomData[roomName].field){fields.rooms[roomName]=roomData[roomName].field}if(roomData[roomName].roomStatus==="join"){if(self.roomEntryListener){self.roomEntryListener(true,roomName)}}processOccupantList(roomName,lastLoggedInList[roomName])}self.emitEvent("roomOccupant",lastLoggedInList)}var processCandidateBody=function(caller,msgData){if(!peerConns[caller]){return}if(iceCandidateFilter){msgData=iceCandidateFilter(msgData,true);if(!msgData){return}}var candidate=new RTCIceCandidate({sdpMLineIndex:msgData.label,sdpMid:msgData.id,candidate:msgData.candidate});var pc=peerConns[caller].pc;function iceAddSuccess(){logDebug("iceAddSuccess: "+JSON.stringify(msgData));processCandidate(msgData.candidate)}function iceAddFailure(domError){self.showError(self.errCodes.ICECANDIDATE_ERR,"bad ice candidate ("+domError.name+"): "+JSON.stringify(msgData))}pc.addIceCandidate(candidate,iceAddSuccess,iceAddFailure)};var flushCachedCandidates=function(caller){var i;if(queuedMessages[caller]){for(i=0;i<queuedMessages[caller].candidates.length;i++){processCandidateBody(caller,queuedMessages[caller].candidates[i])}delete queuedMessages[caller]}};var processOffer=function(caller,msgData){if(peerConns[caller]){doAnswer(caller,msgData,[]);return}var helper=function(wasAccepted,streamNames){if(streamNames){if(typeof streamNames==="string"){streamNames=[streamNames]}else if(streamNames.length===undefined){self.showError(self.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");return}}logDebug("offer accept="+wasAccepted);delete offersPending[caller];if(wasAccepted){if(!self.supportsPeerConnections()){self.showError(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"));return}doAnswer(caller,msgData,streamNames);flushCachedCandidates(caller)}else{sendSignalling(caller,"reject",null,null,null);clearQueuedMessages(caller)}};if(acceptancePending[caller]&&caller<self.myEasyrtcid){delete acceptancePending[caller];if(queuedMessages[caller]){delete queuedMessages[caller]}if(peerConns[caller]){if(peerConns[caller].wasAcceptedCB){peerConns[caller].wasAcceptedCB(true,caller)}delete peerConns[caller]}helper(true);return}offersPending[caller]=msgData;if(!self.acceptCheck){helper(true)}else{self.acceptCheck(caller,helper)}};function processReject(caller){delete acceptancePending[caller];if(queuedMessages[caller]){delete queuedMessages[caller]}if(peerConns[caller]){if(peerConns[caller].wasAcceptedCB){peerConns[caller].wasAcceptedCB(false,caller)}delete peerConns[caller]}}function processAnswer(caller,msgData){delete acceptancePending[caller];if(!peerConns[caller]){return}var isInitialConnect=!peerConns[caller].connectionAccepted;if(isInitialConnect){peerConns[caller].connectionAccepted=true;if(peerConns[caller].wasAcceptedCB){peerConns[caller].wasAcceptedCB(true,caller)}}var onSignalSuccess=function(){};var onSignalFailure=function(errorCode,errorText){if(peerConns[caller]){delete peerConns[caller]}self.showError(errorCode,errorText)};sendQueuedCandidates(caller,onSignalSuccess,onSignalFailure);var pc=peerConns[caller].pc;var sdp;try{if(sdpRemoteFilter){sdp=sdpRemoteFilter(msgData.sdp)}else{sdp=msgData.sdp}}catch(userError){self.showError(self.errCodes.DEVELOPER_ERR,"sdpRemoteFilter failed case: "+userError)}var sd=new RTCSessionDescription({type:msgData.type,sdp:sdp});if(!sd){throw"Could not create the RTCSessionDescription"}logDebug("about to call initiating setRemoteDescription");try{if(sdpRemoteFilter){sd=new RTCSessionDescription({type:sd.type,sdp:sdpRemoteFilter(sd.sdp)})}logDebug("sdp ||  "+JSON.stringify(sd));pc.setRemoteDescription(sd).then(function(){if(pc.connectDataConnection){logDebug("calling connectDataConnection(5001,5002)");if(isInitialConnect){pc.connectDataConnection(5001,5002)}try{var streamName;var acks=peerConns[caller].streamsAddedAcks||{};for(streamName in acks){if(acks.hasOwnProperty(streamName)){acks[streamName](caller,streamName)}}peerConns[caller].streamsAddedAcks={}}catch(userError){self.showError(self.errCodes.DEVELOPER_ERR,"streamAdded receipt function failed")}}},function(message){logDebug("processAnswer setRemoteDescription failed: ",message)})}catch(smdException){logDebug("processAnswer setRemoteDescription error: ",smdException)}flushCachedCandidates(caller)}function processCandidateQueue(caller,msgData){if(peerConns[caller]&&peerConns[caller].pc){processCandidateBody(caller,msgData)}else{if(!peerConns[caller]){queuedMessages[caller]={candidates:[]}}queuedMessages[caller].candidates.push(msgData)}}function onChannelCmd(msg,ackAcceptorFn){var caller=msg.senderEasyrtcid;var msgType=msg.msgType;var msgData=msg.msgData;logDebug("received message of type "+msgType);if(typeof queuedMessages[caller]==="undefined"){clearQueuedMessages(caller)}switch(msgType){case"sessionData":processSessionData(msgData.sessionData);break;case"roomData":processRoomData(msgData.roomData);break;case"iceConfig":processIceConfig(msgData.iceConfig);break;case"forwardToUrl":if(msgData.newWindow){window.open(msgData.forwardToUrl.url)}else{window.location.href=msgData.forwardToUrl.url}break;case"offer":processOffer(caller,msgData);break;case"reject":processReject(caller);break;case"answer":processAnswer(caller,msgData);break;case"candidate":processCandidateQueue(caller,msgData);break;case"hangup":onRemoteHangup(caller);clearQueuedMessages(caller);break;case"error":self.showError(msgData.errorCode,msgData.errorText);break;default:self.showError(self.errCodes.DEVELOPER_ERR,"received unknown message type from server, msgType is "+msgType);return}if(ackAcceptorFn){ackAcceptorFn(self.ackMessage)}}this.updatePresence=function(state,statusText){self.presenceShow=state;self.presenceStatus=statusText;if(self.webSocketConnected){sendSignalling(null,"setPresence",{setPresence:{show:self.presenceShow,status:self.presenceStatus}},null)}};this.getSessionFields=function(){return sessionFields};this.getSessionField=function(name){if(sessionFields[name]){return sessionFields[name].fieldValue}else{return undefined}};this.getRoomOccupantsAsArray=function(roomName){if(!lastLoggedInList[roomName]){return null}else{return Object.keys(lastLoggedInList[roomName])}};this.getRoomOccupantsAsMap=function(roomName){return lastLoggedInList[roomName]};this.isTurnServer=function(ipAddress){return!!self._turnServers[ipAddress]};this.isStunServer=function(ipAddress){return!!self._stunServers[ipAddress]};this.getFreshIceConfig=function(callback){var dataToShip={msgType:"getIceConfig",msgData:{}};if(!callback){callback=function(){}}self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){if(ackMsg.msgType==="iceConfig"){processIceConfig(ackMsg.msgData.iceConfig);callback(true)}else{self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText);callback(false)}})};this.joinRoom=function(roomName,roomParameters,successCB,failureCB){if(self.roomJoin[roomName]){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to join room "+roomName+" which you are already in.");return}var newRoomData={roomName:roomName};if(roomParameters){try{JSON.stringify(roomParameters)}catch(error){self.showError(self.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom");throw"Developer error, see application error messages"}var parameters={};for(var key in roomParameters){if(roomParameters.hasOwnProperty(key)){parameters[key]=roomParameters[key]}}newRoomData.roomParameter=parameters}var msgData={roomJoin:{}};var roomData;var signallingSuccess,signallingFailure;if(self.webSocket){msgData.roomJoin[roomName]=newRoomData;signallingSuccess=function(msgType,msgData){roomData=msgData.roomData;self.roomJoin[roomName]=newRoomData;if(successCB){successCB(roomName)}processRoomData(roomData)};signallingFailure=function(errorCode,errorText){if(failureCB){failureCB(errorCode,errorText,roomName)}else{self.showError(errorCode,self.format(self.getConstantString("unableToEnterRoom"),roomName,errorText))}};sendSignalling(null,"roomJoin",msgData,signallingSuccess,signallingFailure)}else{self.roomJoin[roomName]=newRoomData}};this.leaveRoom=function(roomName,successCallback,failureCallback){var roomItem;if(self.roomJoin[roomName]){if(!self.webSocket){delete self.roomJoin[roomName]}else{self.setRoomApiField(roomName);roomItem={};roomItem[roomName]={roomName:roomName};sendSignalling(null,"roomLeave",{roomLeave:roomItem},function(msgType,msgData){var roomData=msgData.roomData;processRoomData(roomData);if(successCallback){successCallback(roomName)}},function(errorCode,errorText){if(failureCallback){failureCallback(errorCode,errorText,roomName)}})}}};this.getRoomsJoined=function(){var roomsIn={};var key;for(key in self.roomJoin){if(self.roomJoin.hasOwnProperty(key)){roomsIn[key]=true}}return roomsIn};this.getRoomFields=function(roomName){return!fields||!fields.rooms||!fields.rooms[roomName]?undefined:fields.rooms[roomName]};this.getApplicationFields=function(){return fields.application};this.getConnectionFields=function(){return fields.connection};this.useThisSocketConnection=function(alreadyAllocatedSocketIo){preallocatedSocketIo=alreadyAllocatedSocketIo};function processToken(msg){var msgData=msg.msgData;logDebug("entered process token");if(msgData.easyrtcid){self.myEasyrtcid=msgData.easyrtcid}if(msgData.field){fields.connection=msgData.field}if(msgData.iceConfig){processIceConfig(msgData.iceConfig)}if(msgData.stillAliveInterval){stillAlivePeriod=msgData.stillAliveInterval;if(stillAlivePeriod>0){stillAliveEmitter()}}if(msgData.sessionData){processSessionData(msgData.sessionData)}if(msgData.roomData){processRoomData(msgData.roomData)}if(msgData.application.field){fields.application=msgData.application.field}}function sendAuthenticate(successCallback,errorCallback){var cookies,target,i;var easyrtcsid=null;if(self.cookieId&&document.cookie){cookies=document.cookie.split(/[; ]/g);target=self.cookieId+"=";for(i=0;i<cookies.length;i++){if(cookies[i].indexOf(target)===0){easyrtcsid=cookies[i].substring(target.length)}}}var msgData={apiVersion:self.apiVersion,applicationName:self.applicationName,setUserCfg:collectConfigurationInfo(true)};if(!self.roomJoin){self.roomJoin={}}if(self.presenceShow){msgData.setPresence={show:self.presenceShow,status:self.presenceStatus}}if(self.username){msgData.username=self.username}if(self.roomJoin&&!isEmptyObj(self.roomJoin)){msgData.roomJoin=self.roomJoin}if(easyrtcsid){msgData.easyrtcsid=easyrtcsid}if(credential){msgData.credential=credential}self.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:msgData},function(msg){var room;if(msg.msgType==="error"){errorCallback(msg.msgData.errorCode,msg.msgData.errorText);self.roomJoin={}}else{processToken(msg);if(self._roomApiFields){for(room in self._roomApiFields){if(self._roomApiFields.hasOwnProperty(room)){enqueueSendRoomApi(room)}}}if(successCallback){successCallback(self.myEasyrtcid)}}})}function connectToWSServer(successCallback,errorCallback){var i;if(preallocatedSocketIo){self.webSocket=preallocatedSocketIo}else if(!self.webSocket){try{connectionOptions["force new connection"]=true;self.webSocket=io.connect(serverPath,connectionOptions);if(!self.webSocket){throw"io.connect failed"}}catch(socketErr){self.webSocket=0;errorCallback(self.errCodes.SYSTEM_ERROR,socketErr.toString());return}}else{for(i in self.websocketListeners){if(!self.websocketListeners.hasOwnProperty(i)){continue}self.webSocket.removeEventListener(self.websocketListeners[i].event,self.websocketListeners[i].handler)}}self.websocketListeners=[];function addSocketListener(event,handler){self.webSocket.on(event,handler);self.websocketListeners.push({event:event,handler:handler})}addSocketListener("close",function(event){logDebug("the web socket closed")});function handleErrorEvent(){if(self.myEasyrtcid){if(isSocketConnected(self.webSocket)){self.showError(self.errCodes.SIGNAL_ERR,self.getConstantString("miscSignalError"))}else{errorCallback(self.errCodes.CONNECT_ERR,self.getConstantString("noServer"))}}else{errorCallback(self.errCodes.CONNECT_ERR,self.getConstantString("noServer"))}}addSocketListener("error",handleErrorEvent);if(connectionOptions.reconnection!==false)addSocketListener("reconnect_failed",handleErrorEvent);else addSocketListener("connect_error",handleErrorEvent);function connectHandler(event){if(!self.webSocket){self.showError(self.errCodes.CONNECT_ERR,self.getConstantString("badsocket"))}self.webSocketConnected=true;missedAliveResponses=0;logDebug("saw socket-server onconnect event");if(self.webSocketConnected){sendAuthenticate(successCallback,errorCallback)}else{errorCallback(self.errCodes.SIGNAL_ERR,self.getConstantString("icf"))}}if(isSocketConnected(preallocatedSocketIo)){connectHandler(null)}else{addSocketListener("connect",connectHandler)}addSocketListener("easyrtcMsg",onChannelMsg);addSocketListener("easyrtcCmd",onChannelCmd);addSocketListener("disconnect",function(){self.webSocketConnected=false;updateConfigurationInfo=function(){};oldConfig={};disconnectBody()})}function checkIceGatheringState(otherPeer){logDebug("entered checkIceGatheringState");if(peerConns[otherPeer]&&peerConns[otherPeer].pc&&peerConns[otherPeer].pc.iceGatheringState){if(peerConns[otherPeer].pc.iceGatheringState==="complete"){self.sendPeerMessage(otherPeer,"iceGatheringDone",{});logDebug("sent iceGatherDone message to ",otherPeer)}else{setTimeout(function(){checkIceGatheringState(otherPeer)},500)}}else{logDebug("checkIceGatherState: leaving")}}this.connect=function(applicationName,successCallback,errorCallback){if(!io){self.showError(self.errCodes.DEVELOPER_ERR,"Your HTML has not included the socket.io.js library")}if(!preallocatedSocketIo&&self.webSocket){self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to connect when already connected to socket server");return}pc_config={};closedChannel=null;oldConfig={};queuedMessages={};self.applicationName=applicationName;fields={rooms:{},application:{},connection:{}};logDebug("attempt to connect to WebRTC signalling server with application name="+applicationName);if(errorCallback===null){errorCallback=function(errorCode,errorText){self.showError(errorCode,errorText)}}self.setPeerListener(function(easyrtcid,msgType,msgData,targeting){logDebug("received request to supportHalfIceTrickle");if(peerConns[easyrtcid]){peerConns[easyrtcid].supportHalfTrickleIce=true;flushCachedCandidates(easyrtcid);checkIceGatheringState(easyrtcid)}},"supportHalfTrickleIce");connectToWSServer(successCallback,errorCallback)}};return new Easyrtc});(function(root,factory){if(typeof define==="function"&&define.amd){define("easyrtc_app",["easyrtc"],factory)}else if(typeof module==="object"&&module.exports){module.exports=factory(require("easyrtc"))}else{if(typeof window.easyrtc!=="object"||!window.easyrtc){throw new Error("easyrtc_app requires easyrtc")}root.easyrtc=factory(window.easyrtc)}})(this,function(easyrtc,undefined){"use strict";var autoAddCloseButtons=true;easyrtc.dontAddCloseButtons=function(){autoAddCloseButtons=false};function easyAppBody(monitorVideoId,videoIds){var videoIdsP=videoIds||[],numPEOPLE=videoIds.length,videoIdToCallerMap={},onCall=null,onHangup=null;function validateVideoIds(monitorVideoId,videoIds){var i;if(monitorVideoId&&!document.getElementById(monitorVideoId)){easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+monitorVideoId);return false}for(i in videoIds){if(!videoIds.hasOwnProperty(i)){continue}var name=videoIds[i];if(!document.getElementById(name)){easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The caller video id '"+name+"' passed to easyApp was bad.");return false}}return true}function getCallerOfVideo(videoObject){return videoIdToCallerMap[videoObject.id]}function setCallerOfVideo(videoObject,callerEasyrtcId){videoIdToCallerMap[videoObject.id]=callerEasyrtcId}function videoIsFree(obj){var caller=getCallerOfVideo(obj);return caller===""||caller===null||caller===undefined}function getIthVideo(i){if(videoIdsP[i]){return document.getElementById(videoIdsP[i])}else{return null}}function showVideo(video,stream){easyrtc.setVideoObjectSrc(video,stream);if(video.style.visibility){video.style.visibility="visible"}}function hideVideo(video){easyrtc.setVideoObjectSrc(video,"");video.style.visibility="hidden"}if(!validateVideoIds(monitorVideoId,videoIdsP)){throw"bad video element id"}if(monitorVideoId){document.getElementById(monitorVideoId).muted="muted"}easyrtc.addEventListener("roomOccupants",function(eventName,eventData){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);if(!videoIsFree(video)){if(!easyrtc.isPeerInAnyRoom(getCallerOfVideo(video))){if(onHangup){onHangup(getCallerOfVideo(video),i)}setCallerOfVideo(video,null)}}}});easyrtc.setOnCall=function(cb){onCall=cb};easyrtc.setOnHangup=function(cb){onHangup=cb};easyrtc.getIthCaller=function(i){if(i<0||i>=videoIdsP.length){return null}var vid=getIthVideo(i);return getCallerOfVideo(vid)};easyrtc.getSlotOfCaller=function(easyrtcid){var i;for(i=0;i<numPEOPLE;i++){if(easyrtc.getIthCaller(i)===easyrtcid){return i}}return-1};easyrtc.setOnStreamClosed(function(caller){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);if(getCallerOfVideo(video)===caller){hideVideo(video);setCallerOfVideo(video,"");if(onHangup){onHangup(caller,i)}}}});easyrtc.setAcceptChecker(function(caller,helper){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);if(videoIsFree(video)){helper(true);return}}helper(false)});easyrtc.setStreamAcceptor(function(caller,stream){var i;if(easyrtc.debugPrinter){easyrtc.debugPrinter("stream acceptor called")}var video;for(i=0;i<numPEOPLE;i++){video=getIthVideo(i);if(getCallerOfVideo(video)===caller){showVideo(video,stream);if(onCall){onCall(caller,i)}return}}for(i=0;i<numPEOPLE;i++){video=getIthVideo(i);if(videoIsFree(video)){setCallerOfVideo(video,caller);if(onCall){onCall(caller,i)}showVideo(video,stream);return}}video=getIthVideo(0);if(video){easyrtc.hangup(getCallerOfVideo(video));showVideo(video,stream);if(onCall){onCall(caller,0)}}setCallerOfVideo(video,caller)});var addControls,parentDiv,closeButton,i;if(autoAddCloseButtons){addControls=function(video){parentDiv=video.parentNode;setCallerOfVideo(video,"");closeButton=document.createElement("div");closeButton.className="easyrtc_closeButton";closeButton.onclick=function(){if(getCallerOfVideo(video)){easyrtc.hangup(getCallerOfVideo(video));hideVideo(video);setCallerOfVideo(video,"")}};parentDiv.appendChild(closeButton)};for(i=0;i<numPEOPLE;i++){addControls(getIthVideo(i))}}var monitorVideo=null;if(easyrtc.videoEnabled&&monitorVideoId!==null){monitorVideo=document.getElementById(monitorVideoId);if(!monitorVideo){console.error("Programmer error: no object called "+monitorVideoId);return}monitorVideo.muted="muted";monitorVideo.defaultMuted=true}}easyrtc.easyApp=function(applicationName,monitorVideoId,videoIds,onReady,onFailure){var gotMediaCallback=null,gotConnectionCallback=null;easyAppBody(monitorVideoId,videoIds);easyrtc.setGotMedia=function(gotMediaCB){gotMediaCallback=gotMediaCB};easyrtc.setPeerClosedListener(function(easyrtcid){setTimeout(function(){if(easyrtc.getSlotOfCaller(easyrtcid)>=0&&easyrtc.isPeerInAnyRoom(easyrtcid)){easyrtc.call(easyrtcid,function(){},function(){},function(){})}},1e3)});easyrtc.setGotConnection=function(gotConnectionCB){gotConnectionCallback=gotConnectionCB};function nextInitializationStep(){if(gotConnectionCallback){gotConnectionCallback(true,"")}onReady(easyrtc.myEasyrtcid)}function postGetUserMedia(){if(gotMediaCallback){gotMediaCallback(true,null)}if(monitorVideoId!==null){easyrtc.setVideoObjectSrc(document.getElementById(monitorVideoId),easyrtc.getLocalStream())}function connectError(errorCode,errorText){if(gotConnectionCallback){gotConnectionCallback(false,errorText)}else if(onFailure){onFailure(easyrtc.errCodes.CONNECT_ERR,errorText)}else{easyrtc.showError(easyrtc.errCodes.CONNECT_ERR,errorText)}}easyrtc.connect(applicationName,nextInitializationStep,connectError)}var stream=easyrtc.getLocalStream(null);if(stream){postGetUserMedia()}else{easyrtc.initMediaSource(postGetUserMedia,function(errorCode,errorText){if(gotMediaCallback){gotMediaCallback(false,errorText)}else if(onFailure){onFailure(easyrtc.errCodes.MEDIA_ERR,errorText)}else{easyrtc.showError(easyrtc.errCodes.MEDIA_ERR,errorText)}},null)}};return easyrtc});